---
description: Swarm 模式下的服务如何工作
keywords: docker, container, cluster, swarm mode, node, 容器, 集群, 服务
title: 服务如何工作
weight: 20
---

要在 Docker Engine 处于 Swarm 模式时部署应用程序镜像，您需要创建一个服务 (service)。通常，服务是某个大型应用程序上下文中的一个微服务镜像。服务的示例可能包括 HTTP 服务器、数据库或您希望在分布式环境中运行的任何其他类型的可执行程序。

创建服务时，您需要指定使用哪个容器镜像以及在运行的容器内部执行哪些命令。您还可以为服务定义选项，包括：

* Swarm 在 Swarm 外部使该服务可用的端口
* 服务连接到 Swarm 中其他服务的 overlay 网络
* CPU 和内存的限制 (limits) 与预留 (reservations)
* 滚动更新策略
* 在 Swarm 中运行的镜像副本数量

## 服务、任务与容器 (Services, tasks, and containers)

当您将服务部署到 Swarm 时，Swarm 管理节点会接受您的服务定义作为服务的期望状态。然后，它将服务调度到 Swarm 中的节点上，作为一个或多个副本任务 (replica tasks)。这些任务在 Swarm 的节点上相互独立地运行。

例如，假设您想要在三个 HTTP 监听器实例之间进行负载均衡。下图显示了一个具有三个副本的 HTTP 监听器服务。监听器的三个实例中的每一个都是 Swarm 中的一个任务。

![具有三个副本的 HTTP 监听器服务](../images/services-diagram.webp?w=550)

容器是一个隔离的进程。在 Swarm 模式模型中，每个任务恰好调用一个容器。任务类似于调度程序放置容器的“插槽 (slot)”。一旦容器启动，调度程序就会识别出该任务处于运行状态。如果容器未通过健康检查或终止，则该任务终止。

## 任务与调度 (Tasks and scheduling)

任务 (task) 是 Swarm 内调度的原子单位。当您通过创建或更新服务来声明期望的服务状态时，编排器通过调度任务来实现该期望状态。例如，您定义了一个服务，指示编排器始终保持运行三个 HTTP 监听器实例。编排器通过创建三个任务来响应。每个任务都是调度程序通过启动容器来填充的插槽。容器是任务的实例化。如果 HTTP 监听器任务随后未通过其健康检查或崩溃，编排器会创建一个新的副本任务，从而启动一个新的容器。

任务是一个单向机制。它单调地经历一系列状态：assigned (已分配)、prepared (已准备)、running (运行中) 等。如果任务失败，编排器会移除该任务及其容器，然后根据服务指定的期望状态创建一个新任务来替换它。

Docker Swarm 模式的底层逻辑是一个通用的调度程序和编排器。服务和任务抽象本身并不知道它们实现的容器。假设您可以实现其他类型的任务，如虚拟机任务或非容器化进程任务。调度程序和编排器对任务的类型是不可知的。然而，当前版本的 Docker 仅支持容器任务。

下图显示了 Swarm 模式如何接受服务创建请求并将任务调度到工作节点。

![服务流程](../images/service-lifecycle.webp?w=700)

### 待处理服务 (Pending services)

服务的配置方式可能会导致当前 Swarm 中没有节点可以运行其任务。在这种情况下，服务保持在 `pending` (待处理) 状态。以下是一些服务可能保持在 `pending` 状态的示例。

> [!TIP]
> 如果您唯一的意图是防止服务被部署，请将服务规模扩展到 0，而不是尝试将其配置为保持在 `pending` 状态。

- 如果所有节点都处于暂停 (paused) 或排空 (drained) 状态，而您创建了一个服务，那么该服务将一直处于待处理状态，直到有节点变得可用。实际上，第一个变得可用的节点将获得所有任务，因此在生产环境中这并不是一件好事。

- 您可以为服务预留特定数量的内存。如果 Swarm 中没有任何节点拥有所需数量的内存，则服务将保持在待处理状态，直到有可以运行其任务的节点可用。如果您指定了一个非常大的值 (如 500 GB)，则任务将永远保持待处理状态，除非您真的有一个可以满足它的节点。

- 您可以对服务施加放置约束 (placement constraints)，而这些约束在给定时间可能无法被满足。

这种行为说明了您任务的要求和配置并未与 Swarm 的当前状态紧密绑定。作为 Swarm 的管理员，您声明 Swarm 的期望状态，而管理节点会与 Swarm 中的节点协作来创建该状态。您不需要微管理 Swarm 上的任务。

## 复制服务与全局服务 (Replicated and global services)

有两种类型的服务部署：复制型 (replicated) 和全局型 (global)。

对于复制服务，您指定要运行的相同任务的数量。例如，您决定部署一个具有三个副本的 HTTP 服务，每个副本都提供相同的内容。

全局服务是在每个节点上运行一个任务的服务。没有预先指定的任务数量。每当您向 Swarm 添加一个节点时，编排器都会创建一个任务，调度程序会将该任务分配给新节点。全局服务的理想候选对象是监控代理、反病毒扫描器或您希望在 Swarm 中每个节点上运行的其他类型的容器。

下图显示了一个由三个服务副本组成的灰色服务和一个黑色全局服务。

![全局服务与复制服务对比](../images/replicated-vs-global.webp?w=450)

## 了解更多

* 阅读关于 Swarm 模式 [节点 (nodes)](nodes.md) 如何工作的信息。
* 了解 [PKI](pki.md) 在 Swarm 模式下如何工作。
