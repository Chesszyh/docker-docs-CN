---
title: 选择存储驱动程序
weight: 10
description: 了解如何为您的容器选择合适的存储驱动程序。
keywords: container, storage, driver, btrfs, zfs, overlay, overlay2, 容器, 存储, 驱动程序
---

理想情况下，写入容器可写层的数据应该非常少，您应该使用 Docker 卷 (volumes) 来写入数据。然而，某些工作负载要求您能够写入容器的可写层。这就是存储驱动程序的作用所在。

Docker 通过可插拔架构支持多种存储驱动程序。存储驱动程序控制镜像和容器在 Docker 主机上的存储和管理方式。在阅读了 [存储驱动程序概览](./_index.md) 之后，下一步是为您的工作负载选择最佳的存储驱动程序。在最常见的场景中，应使用综合性能和稳定性最佳的存储驱动程序。

> [!NOTE]
> 本页讨论的是适用于 Linux 上 Docker Engine 的存储驱动程序。如果您运行的 Docker 守护进程是以 Windows 作为宿主操作系统，则唯一受支持的存储驱动程序是 `windowsfilter`。有关更多信息，请参阅 [windowsfilter](windowsfilter-driver.md)。

Docker Engine 在 Linux 上提供以下存储驱动程序：

| 驱动程序          | 描述                                                                                                                                                                                                                                                                                                                                          |
| :---------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `overlay2`        | `overlay2` 是所有当前受支持的 Linux 发行版的首选存储驱动程序，无需额外配置。                                                                                                                                                                                                                     |
| `fuse-overlayfs`  | `fuse-overlayfs` 仅在不支持 rootless `overlay2` 的旧主机上运行 Rootless Docker 时被优先考虑。自 Linux 内核 5.11 以来，不需要使用 `fuse-overlayfs` 驱动程序，`overlay2` 即使在无根模式下也能工作。详情请参阅 [无根模式文档](/manuals/engine/security/rootless.md)。 |
| `btrfs` 和 `zfs` | `btrfs` 和 `zfs` 存储驱动程序允许使用高级选项，例如创建“快照 (snapshots)”，但需要更多的维护和设置。每一个都依赖于正确配置的底层文件系统。                                                                                                                                   |
| `vfs`             | `vfs` 存储驱动程序用于测试目的，以及在无法使用写时复制 (copy-on-write) 文件系统的情况下。该存储驱动程序的性能较差，通常不建议在生产环境中使用。                                                                                                                        |

如果未显式配置存储驱动程序，Docker Engine 会根据存储驱动程序是否满足前提条件，按照优先级列表自动选择一个兼容的存储驱动程序。您可以在 [Docker Engine {{% param "docker_ce_version" %}} 的源代码](https://github.com/moby/moby/blob/v{{% param "docker_ce_version" %}}/daemon/graphdriver/driver_linux.go#L52-L53) 中看到这个顺序。
{ #storage-driver-order }

某些存储驱动程序要求您对底层文件系统使用特定的格式。如果您有外部要求必须使用特定的底层文件系统，这可能会限制您的选择。参见 [支持的底层文件系统](#supported-backing-filesystems)。

在缩小了可供选择的存储驱动程序范围后，您的选择将取决于工作负载的特征以及您需要的稳定性水平。参见 [其他考虑因素](#other-considerations) 以获取有关最终决定的帮助。

## 各 Linux 发行版受支持的存储驱动程序

> [!NOTE]
>
> Docker Desktop 不支持通过编辑守护进程配置文件来修改存储驱动程序。仅支持默认的 `overlay2` 驱动程序或 [containerd 存储](/manuals/desktop/features/containerd.md)。下表也不适用于无根模式下的 Docker Engine。有关无根模式下可用的驱动程序，请参阅 [无根模式文档](/manuals/engine/security/rootless.md)。

您的操作系统和内核可能并不支持每一种存储驱动程序。例如，仅当您的系统使用 `btrfs` 作为存储时，才支持 `btrfs`。通常，以下配置在最新版本的 Linux 发行版上可以工作：

| Linux 发行版         | 推荐的存储驱动程序           | 备选驱动程序         |
| :------------------- | :--------------------------- | :------------------- |
| Ubuntu               | `overlay2`                   | `zfs`, `vfs`         |
| Debian               | `overlay2`                   | `vfs`                |
| CentOS               | `overlay2`                   | `zfs`, `vfs`         |
| Fedora               | `overlay2`                   | `zfs`, `vfs`         |
| SLES 15              | `overlay2`                   | `vfs`                |
| RHEL                 | `overlay2`                   | `vfs`                |

如有疑问，最佳的通用配置是使用带有支持 `overlay2` 存储驱动程序内核的现代 Linux 发行版，并针对写密集型工作负载使用 Docker 卷，而不是依赖于将数据写入容器的可写层。

`vfs` 存储驱动程序通常不是最佳选择，它主要用于在不支持其他任何存储驱动程序的情况下的调试目的。在使用 `vfs` 存储驱动程序之前，请务必阅读 [其性能和存储特征以及限制](vfs-driver.md)。

上表中的建议已知适用于大量用户。如果您使用推荐的配置并发现了可复现的问题，该问题很可能会被迅速修复。如果您想使用的驱动程序根据此表不属于推荐配置，则需自行承担风险运行。您仍然可以且应该报告遇到的任何问题。但是，此类问题的优先级低于使用推荐配置时遇到的问题。

根据您的 Linux 发行版，可能还有其他存储驱动程序可用，例如 `btrfs`。这些存储驱动程序对于特定的用例可能具有优势，但可能需要额外的设置或维护，因此不建议用于常见场景。有关详细信息，请参阅这些存储驱动程序的文档。

## 支持的底层文件系统

就 Docker 而言，底层文件系统是指 `/var/lib/docker/` 所在的那个文件系统。某些存储驱动程序仅适用于特定的底层文件系统。

| 存储驱动程序     | 支持的底层文件系统                                    |
| :--------------- | :-----------------------------------------------------|
| `overlay2`       | `xfs` (带有 ftype=1)、`ext4`、`btrfs` (及更多)        |
| `fuse-overlayfs` | 任何文件系统                                          |
| `btrfs`          | `btrfs`                                               |
| `zfs`            | `zfs`                                                 |
| `vfs`            | 任何文件系统                                          |

> [!NOTE]
>
> 大多数文件系统如果具备所需的功能，都应该可以工作。请查阅 [OverlayFS](https://www.kernel.org/doc/html/latest/filesystems/overlayfs.html) 以获取更多信息。


## 其他考虑因素

### 与您的工作负载的适用性

除其他因素外，每种存储驱动程序都有自己的性能特征，使其或多或少地适合不同的工作负载。请考虑以下归纳：

- `overlay2` 工作在文件级别而不是块级别。这能更有效地利用内存，但在写密集型工作负载中，容器的可写层可能会变得非常大。
- 诸如 `btrfs` 和 `zfs` 之类的块级存储驱动程序在写密集型工作负载中表现更好 (尽管不如 Docker 卷)。
- `btrfs` 和 `zfs` 需要大量的内存。
- `zfs` 是高密度工作负载 (如 PaaS) 的良好选择。

有关性能、适用性和最佳实践的更多信息，可在每种存储驱动程序的文档中找到。

### 共享存储系统与存储驱动程序

如果您使用 SAN、NAS、硬件 RAID 或其他共享存储系统，这些系统可能提供高可用性、更高的性能、精简置备、去重和压缩。在许多情况下，Docker 可以在这些存储系统之上工作，但 Docker 并不与它们紧密集成。

每个 Docker 存储驱动程序都基于 Linux 文件系统或卷管理器。请务必遵循现有的最佳实践，在您的共享存储系统之上操作您的存储驱动程序 (文件系统或卷管理器)。例如，如果在共享存储系统之上使用 ZFS 存储驱动程序，请务必遵循在该特定共享存储系统之上操作 ZFS 文件系统的最佳实践。

### 稳定性

对于某些用户来说，稳定性比性能更重要。尽管 Docker 认为这里提到的所有存储驱动程序都是稳定的，但有些驱动程序较新且仍在活跃开发中。通常，`overlay2` 提供了最高的稳定性。

### 针对您自己的工作负载进行测试

您可以在不同的存储驱动程序上运行您自己的工作负载来测试 Docker 的性能。确保使用等效的硬件和工作负载来匹配生产环境，这样您就可以看到哪种存储驱动程序提供了最佳的综合性能。

## 检查当前的存储驱动程序

每个单独存储驱动程序的详细文档都说明了使用该驱动程序的所有设置步骤。

要查看 Docker 当前正在使用的存储驱动程序，请使用 `docker info` 并查找 `Storage Driver` 行：

```console
$ docker info

Containers: 0
Images: 0
Storage Driver: overlay2
 Backing Filesystem: xfs
<...>
```

要更改存储驱动程序，请参阅新存储驱动程序的具体说明。某些驱动程序需要额外的配置，包括对 Docker 主机上的物理磁盘或逻辑磁盘的配置。

> [!IMPORTANT]
>
> 更改存储驱动程序后，任何现有的镜像和容器都将无法访问。这是因为它们的层无法被新的存储驱动程序使用。如果您还原更改，可以再次访问旧的镜像和容器，但使用新驱动程序拉取或创建的任何镜像和容器随后将无法访问。

## 相关信息

- [存储驱动程序](./_index.md)
- [`overlay2` 存储驱动程序](overlayfs-driver.md)
- [`btrfs` 存储驱动程序](btrfs-driver.md)
- [`zfs` 存储驱动程序](zfs-driver.md)
- [`windowsfilter` 存储驱动程序](windowsfilter-driver.md)
