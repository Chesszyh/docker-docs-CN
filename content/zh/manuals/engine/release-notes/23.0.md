---
title: Docker Engine 23.0 发布说明
linkTitle: Engine v23.0
description: 了解 Docker Engine 23.0 版的新功能、错误修复和重大变更
keywords: docker, docker engine, ce, whats new, release notes, 发布说明
toc_min: 1
toc_max: 2
---

> [!NOTE]
>
> 从 Docker Engine 23.0.0 版本开始，Buildx 以独立软件包 `docker-buildx-plugin` 的形式分发。在早期版本中，Buildx 包含在 `docker-ce-cli` 软件包中。当您升级到此版本的 Docker Engine 时，请确保更新所有软件包。例如，在 Ubuntu 上：
>
> ```console
> $ sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
> ```
>
> 参考对应您操作系统的 [Docker Engine 安装说明][1]，了解有关升级 Docker Engine 的更多细节。

[1]: ../install/_index.md

本页描述了 Docker Engine 23.0 版的最新变更、新增内容、已知问题和修复。

有关以下内容的更多信息：

- 已弃用和已移除的功能，请参阅 [已弃用的 Engine 功能](../deprecated.md)。
- Engine API 的变更，请参阅 [Engine API 版本历史](/reference/api/engine/version-history.md)。

从 23.0.0 版本开始，Docker Engine 不再使用 CalVer 版本命名法，而是开始使用 [SemVer 版本格式](https://semver.org/)。更改版本格式是迈向 Go 模块兼容性的一步，但该仓库尚未完全使用 Go 模块，仍需使用 "+incompatible" 版本。迈向未来版本中 Go 模块兼容性的工作仍在继续。

## 23.0.6

{{< release-date date="2023-05-08" >}}

有关此版本中拉取请求 (PR) 和变更的完整列表，请参考相关的 GitHub 里程碑：

- [docker/cli, 23.0.6 里程碑](https://github.com/docker/cli/issues?q=is%3Aclosed+milestone%3A23.0.6)
- [moby/moby, 23.0.6 里程碑](https://github.com/moby/moby/issues?q=is%3Aclosed+milestone%3A23.0.6)

### 错误修复与改进

- 修复了 vfs 存储驱动程序在 NFS 上无法工作的问题。[moby/moby#45465](https://github.com/moby/moby/pull/45465)

### 打包更新

- 将 Go 更新至 `1.19.9`。[docker/docker-ce-packaging#889](https://github.com/docker/docker-ce-packaging/pull/889), [docker/cli#4254](https://github.com/docker/cli/pull/4254), [moby/moby#45455](https://github.com/moby/moby/pull/45455)
- 将 `containerd` 更新至 [v1.6.21](https://github.com/containerd/containerd/releases/tag/v1.6.21)
- 将 `runc` 更新至 [v1.1.7](https://github.com/opencontainers/runc/releases/tag/v1.1.7)


## 23.0.5

{{< release-date date="2023-04-26" >}}

有关此版本中拉取请求 (PR) 和变更的完整列表，请参考相关的 GitHub 里程碑：

- [docker/cli, 23.0.5 里程碑](https://github.com/docker/cli/milestone/79?closed=1)
- [moby/moby, 23.0.5 里程碑](https://github.com/moby/moby/milestone/118?closed=1)

### 错误修复与改进

- 在清理卷时增加了 `--all` / `-a` 选项。[docker/cli#4229](https://github.com/docker/cli/pull/4229)
- 为 `docker info` 增加了 `--format=json` 选项。[docker/cli#4320](https://github.com/docker/cli/pull/4230)
- 修复了使用 AWSLogs 日志驱动程序时的日志丢失问题。[moby/moby#45350](https://github.com/moby/moby/pull/45350)
- 修复了 v23.0.4 中引入的一个回归问题，即当提供了 fixed-cidr 配置参数但未提供 bip 时，dockerd 拒绝启动的问题。[moby/moby#45403](https://github.com/moby/moby/pull/45403)
- 修复了守护进程启动期间 libnetwork 中的崩溃 (panic) 问题。[moby/moby#45376](https://github.com/moby/moby/pull/45376)
- 修复了使用 `buildx` 构建镜像时不发送 "tag" 事件的问题。[moby/moby#45410](https://github.com/moby/moby/pull/45410)

### 打包更新

- 将 Compose 更新至 `2.17.3`。[docker/docker-ce-packaging#883](https://github.com/docker/docker-ce-packaging/pull/883)

## 23.0.4

{{< release-date date="2023-04-17" >}}

有关此版本中拉取请求 (PR) 和变更的完整列表，请参考相关的 GitHub 里程碑：

- [docker/cli, 23.0.4 里程碑](https://github.com/docker/cli/milestone/77?closed=1)
- [moby/moby, 23.0.4 里程碑](https://github.com/moby/moby/milestone/117?closed=1)

### 错误修复与改进

- 修复了 Docker CLI 23.0.0 中的性能回归问题 [docker/cli#4141](https://github.com/docker/cli/pull/4141)。
- 修复了 `docker cp` 的进度指示器无法正常工作的问题 [docker/cli#4157](https://github.com/docker/cli/pull/4157)。
- 修复了 `docker compose --file` 的 shell 补全问题 [docker/cli#4177](https://github.com/docker/cli/pull/4177)。
- 修复了由 `daemon.json` 中 "default-address-pools" 处理不当引起的错误 [moby/moby#45246](https://github.com/moby/moby/pull/45246)。

### 打包更新

- 修复了 CentOS 9 Stream 缺失软件包的问题。
- 将 Go 更新至 `1.19.8`。[docker/docker-ce-packaging#878](https://github.com/docker/docker-ce-packaging/pull/878), [docker/cli#4164](https://github.com/docker/cli/pull/4164), [moby/moby#45277](https://github.com/moby/moby/pull/45277)，包含了针对 [CVE-2023-24537](https://github.com/advisories/GHSA-fp86-2355-v99r)、[CVE-2023-24538](https://github.com/advisories/GHSA-v4m2-x4rp-hv22)、[CVE-2023-24534](https://github.com/advisories/GHSA-8v5j-pwr7-w5f8) 和 [CVE-2023-24536](https://github.com/advisories/GHSA-9f7g-gqwh-jpf5) 的修复。


## 23.0.3

{{< release-date date="2023-04-04" >}}

> [!NOTE]
> 
> 由于 CentOS 9 Stream 软件包仓库的问题，CentOS 9 的软件包目前不可用。CentOS 9 的软件包可能会在稍后或作为下一个 (23.0.4) 补丁版本的一部分添加。

### 错误修复与改进

- 修复了许多可能导致 Swarm 加密 overlay 网络无法履行其保证的问题，解决了 [CVE-2023-28841](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-28841)、[CVE-2023-28840](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-28840) 和 [CVE-2023-28842](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-28842)。
  - 内核不支持加密 overlay 网络现在会报错。
  - 加密 overlay 网络会立即设置，而不是等待多个节点连接。
  - 加密 overlay 网络现在通过使用 `xt_bpf` 内核模块在 Red Hat Enterprise Linux 9 上可用。
  - Swarm overlay 网络的用户应查看 [GHSA-vwm3-crmr-xfxw](https://github.com/moby/moby/security/advisories/GHSA-vwm3-crmr-xfxw) 以确保没有发生非预期的暴露。

### 打包更新

- 将 `containerd` 更新至 [v1.6.20](https://github.com/containerd/containerd/releases/tag/v1.6.20)。
- 将 `runc` 更新至 [v1.1.5](https://github.com/opencontainers/runc/releases/tag/v1.1.5)。


## 23.0.2

{{< release-date date="2023-03-28" >}}

有关此版本中拉取请求 (PR) 和变更的完整列表，请参考相关的 GitHub 里程碑：

- [docker/cli, 23.0.2 里程碑](https://github.com/docker/cli/milestone/75?closed=1)
- [moby/moby, 23.0.2 里程碑](https://github.com/moby/moby/milestone/114?closed=1)

### 错误修复与改进

- 在检测到启用了 AppArmor 的内核时，彻底解决了 `apparmor_parser` 缺失的检查问题。[containerd/containerd#8087](https://github.com/containerd/containerd/pull/8087), [moby/moby#45043](https://github.com/moby/moby/pull/45043)
- 确保在生成 BuildKit buildinfo 时从 Git URL 中脱敏凭据。修复了 [CVE-2023-26054](https://github.com/moby/buildkit/security/advisories/GHSA-gc89-7gcr-jxqc)。[moby/moby#45110](https://github.com/moby/moby/pull/45110)
- 修复了 Dockerfile 中 `VOLUME` 行创建的匿名卷被排除在卷清理之外的问题。[moby/moby#45159](https://github.com/moby/moby/pull/45159)
- 修复了在 Swarm 节点上移除卷期间无法正确传播错误的问题。[moby/moby#45155](https://github.com/moby/moby/pull/45155)
- 通过禁用 mergeop/diffop 优化，临时绕过了 BuildKit `COPY --link` 中的一个 bug。[moby/moby#45112](https://github.com/moby/moby/pull/45112)
- 在删除父 Swarm 作业时，正确清理子任务。[moby/swarmkit#3112](https://github.com/moby/swarmkit/pull/3112), [moby/moby#45107](https://github.com/moby/moby/pull/45107)
- 修复了 Swarm 服务创建逻辑，以便可以同时使用 GenericResource 和非默认网络。[moby/swarmkit#3082](https://github.com/moby/swarmkit/pull/3082), [moby/moby#45107](https://github.com/moby/moby/pull/45107)
- 修复了 Swarm CSI 支持要求 CSI 插件提供暂存端点才能发布卷的问题。[moby/swarmkit#3116](https://github.com/moby/swarmkit/pull/3116), [moby/moby#45107](https://github.com/moby/moby/pull/45107)
- 修复了某些配置下由日志缓冲引起的崩溃 (panic)。[containerd/fifo#47](https://github.com/containerd/fifo/pull/47), [moby/moby#45051](https://github.com/moby/moby/pull/45051)
- 在 REST 到 Swarm gRPC API 转换层中以 debug 级别记录错误，以减少冗余和噪音。[moby/moby#45016](https://github.com/moby/moby/pull/45016)
- 修复了在容器外部使用 `systemd-resolved` 时，影响使用 `--dns-opt` 或 `--dns-search` 创建的容器的 DNS 解析问题。[moby/moby#45000](https://github.com/moby/moby/pull/45000)
- 修复了在记录处理源自容器内部的 DNS 查询错误时发生的崩溃 (panic)。[moby/moby#44980](https://github.com/moby/moby/pull/44980)
- 通过允许用户使用 `--size=false` 选择不进行大小计算，提高了 `docker ps` 的速度。[docker/cli#4107](https://github.com/docker/cli/pull/4107)
- 将 Bash 补全支持扩展到所有插件。[docker/cli#4092](https://github.com/docker/cli/pull/4092)
- 修复了当存在由 `cmd.exe` 设置的特殊环境变量时，`docker stack deploy` 在 Windows 上失败的问题。[docker/cli#4083](https://github.com/docker/cli/pull/4083)
- 通过将空镜像标签视为与 `<none>` 相同，为未来的 API 版本增加了前向兼容性。[docker/cli#4065](https://github.com/docker/cli/pull/4065)
- 原子地写入上下文文件以大大降低损坏概率，并改进了损坏上下文的错误消息。[docker/cli#4063](https://github.com/docker/cli/pull/4063)

### 打包

- 将 Go 更新至 `1.19.7`。[docker/docker-ce-packaging#857](https://github.com/docker/docker-ce-packaging/pull/857), [docker/cli#4086](https://github.com/docker/cli/pull/4086), [moby/moby#45137](https://github.com/moby/moby/pull/45137)
- 将 `containerd` 更新至 `v1.6.19`。[moby/moby#45084](https://github.com/moby/moby/pull/45084), [moby/moby#45099](https://github.com/moby/moby/pull/45099)
- 将 Buildx 更新至 `v0.10.4`。[docker/docker-ce-packaging#855](https://github.com/docker/docker-ce-packaging/pull/855)
- 将 Compose 更新至 `v2.17.2`。[docker/docker-ce-packaging#867](https://github.com/docker/docker-ce-packaging/pull/867)

## 23.0.1

{{< release-date date="2023-02-09" >}}

有关此版本中拉取请求 (PR) 和变更的完整列表，请参考相关的 GitHub 里程碑：

- [docker/cli, 23.0.1 里程碑](https://github.com/docker/cli/milestone/73?closed=1)
- [moby/moby, 23.0.1 里程碑](https://github.com/moby/moby/milestone/113?closed=1)

### 错误修复与改进

- 修复了如果内核启用了 AppArmor 但 `apparmor_parser` 不可用时，容器无法启动的问题。[moby/moby#44942](https://github.com/moby/moby/pull/44942)
- 修复了启用了 BuildKit 且带有内联缓存的构建导致守护进程崩溃的问题。[moby/moby#44944](https://github.com/moby/moby/pull/44944)
- 修复了 BuildKit 错误加载由旧版本创建的缓存层的问题。[moby/moby#44959](https://github.com/moby/moby/pull/44959)
- 修复了升级前创建的 `ipvlan` 网络会阻止守护进程启动的问题。[moby/moby#44937](https://github.com/moby/moby/pull/44937)
- 修复了 `overlay2` 存储驱动程序在不支持的底层文件系统上初始化时，在 `metacopy` 测试中过早失败的问题。[moby/moby#44922](https://github.com/moby/moby/pull/44922)
- 修复了 `exec` 退出事件在 Kata Containers 等某些运行时下被误解为容器退出的问题。[moby/moby#44892](https://github.com/moby/moby/pull/44892)
- 改进了由于 API 在请求中途挂断导致的截断 JSON 响应时 CLI 返回的错误消息。[docker/cli#4004](https://github.com/docker/cli/pull/4004)
- 修复了尝试使用由 Go 1.20 编译的 `runc` 执行目录时错误的 CLI 退出代码。[docker/cli#4004](https://github.com/docker/cli/pull/4004)
- 修复了将 `--device-write-bps` 的大小参数错误处理为路径的问题。[docker/cli#4004](https://github.com/docker/cli/pull/4004)

### 打包

- 在 RPM 和 DEB 打包中增加了 `/etc/docker` 目录。[docker/docker-ce-packaging#842](https://github.com/docker/docker-ce-packaging/pull/842)
  - 并非所有用例都会受益；如果您依赖此目录，应显式执行 `mkdir -p /etc/docker`。
- 将 Compose 更新至 `v2.16.0`。[docker/docker-ce-packaging#844](https://github.com/docker/docker-ce-packaging/pull/844)

## 23.0.0

{{< release-date date="2023-02-01" >}}

有关此版本中拉取请求 (PR) 和变更的完整列表，请参考相关的 GitHub 里程碑：

- [docker/cli, 23.0.0 里程碑](https://github.com/docker/cli/milestone/51?closed=1)
- [moby/moby, 23.0.0 里程碑](https://github.com/moby/moby/milestone/91?closed=1)

### 新增功能

- 在 Linux 上将 Buildx 和 BuildKit 设置为默认构建器。[moby/moby#43992](https://github.com/moby/moby/pull/43992)
  - 将 `docker build` 别名为 `docker buildx build`。[docker/cli#3314](https://github.com/docker/cli/pull/3314)
  - 通过显式设置 `DOCKER_BUILDKIT=0` 仍可使用旧版构建器。
  - BuildKit 和旧版构建器在处理多阶段构建时存在差异。更多信息请参阅 [多阶段构建](/manuals/build/building/multi-stage.md#differences-between-legacy-builder-and-buildkit)。
- 增加了对拉取 `zstd` 压缩层的支持。[moby/moby#41759](https://github.com/moby/moby/pull/41759), [moby/moby#42862](https://github.com/moby/moby/pull/42862)
- 在 Linux 上增加了对兼容 containerd runtime v2 API 的替代 OCI 运行时的支持。[moby/moby#43887](https://github.com/moby/moby/pull/43887), [moby/moby#43993](https://github.com/moby/moby/pull/43993)
- 在 Windows 上增加了对 containerd `runhcs` shim 的支持 (默认关闭)。[moby/moby#42089](https://github.com/moby/moby/pull/42089)
- 增加了 `dockerd --validate` 以检查守护进程 JSON 配置并退出。[moby/moby#42393](https://github.com/moby/moby/pull/42393)
- 增加了通过标志或 JSON 配置来配置守护进程 HTTP 代理的能力。[moby/moby#42835](https://github.com/moby/moby/pull/42835)
- 增加了对 RFC 3021 点对点网络 (IPv4 /31s) 和单主机 (IPv4 /32s) 的支持。对于具有两个或更少地址的网络，IPAM 不再预留网络和广播地址。[moby/moby#42626](https://github.com/moby/moby/pull/42626)
- 增加了在 `ipvlan` 网络驱动程序中设置 `ipvlan_flag` 和使用 `l3s` `ipvlan_mode` 的支持。[moby/moby#42542](https://github.com/moby/moby/pull/42542)
- 增加了显示 `overlay2` 存储驱动程序 `metacopy` 选项值的功能。[moby/moby#43557](https://github.com/moby/moby/pull/43557)
- 增加了使用 `IDType://ID` 语法描述 Windows 设备的支持。[moby/moby#43368](https://github.com/moby/moby/pull/43368)
- 增加了对 `RootlessKit`、`slirp4netns` 和 `VPNKit` 版本报告的支持。[moby/moby#42330](https://github.com/moby/moby/pull/42330)
- 增加了对 SwarmKit 集群卷 (CSI) 的实验性支持。[moby/moby#41982](https://github.com/moby/moby/pull/41982)
  - CLI：为 `docker volume` 增加了集群卷 (CSI) 选项。[docker/cli#3606](https://github.com/docker/cli/pull/3606)
  - CLI：为 `docker stack` 增加了集群卷 (CSI) 支持。[docker/cli#3662](https://github.com/docker/cli/pull/3662)
- 在 `docker stack deploy` 中增加了对 SwarmKit 作业 (jobs) 的支持。[docker/cli#2907](https://github.com/docker/cli/pull/2907)
- 增加了 `docker stack config` 命令，用于输出 `stack deploy` 使用的合并及插值后的配置文件。[docker/cli#3544](https://github.com/docker/cli/pull/3544)
- 增加了新的 `docker context show` 命令，用于打印当前上下文的名称。[docker/cli#3567](https://github.com/docker/cli/pull/3567)
- 为所有支持 `--format` 标志的命令增加了 `--format=json` 作为 `--format="{{ json . }}"` 的简写变体。[docker/cli#2936](https://github.com/docker/cli/pull/2936)
- 为 `docker create` 和 `docker run` 命令增加了 `--quiet` 选项，以在拉取镜像时抑制输出。[docker/cli#3377](https://github.com/docker/cli/pull/3377)
- 为 `docker network rm` 子命令增加了 `--force` 选项。即使网络不存在，也让 CLI 返回 0 退出代码。对移除网络的服务器端流程没有影响。[docker/cli#3547](https://github.com/docker/cli/pull/3547)
- 为 `docker stop` 和 `docker restart` 增加了 `--signal` 选项。[docker/cli#3614](https://github.com/docker/cli/pull/3614)
- 为 `docker-proxy` 增加了 `-v/--version` 标志。[moby/moby#44703](https://github.com/moby/moby/pull/44703)
- 守护进程在无根模式下运行时，现在会在常见的用户级路径中发现插件。[moby/moby#44778](https://github.com/moby/moby/pull/44778)
- 守护进程现在可以优雅地处理 JSON 配置文件中常见的备选 JSON 编码，并报告有用的错误。[moby/moby#44777](https://github.com/moby/moby/pull/44777), [moby/moby#44832](https://github.com/moby/moby/pull/44832)
  - 接受带有字节顺序标记 (BOM) 的 UTF-8。
  - 接受带有字节顺序标记 (BOM) 的 UTF-16。
  - 能够及早报告无效的 UTF-8 并给出易于理解的错误消息。
- 允许通过 `docker commit` 使用 `STOPSIGNAL`。[moby/moby#43369](https://github.com/moby/moby/pull/43369)
- 为 `awslogs` 日志驱动程序增加了一个新选项，允许在 CloudWatch 中跳过日志流的创建。[moby/moby#42132](https://github.com/moby/moby/pull/42132)
- 为 `awslogs` 日志驱动程序增加了一个新选项，用于指定发送到 CloudWatch 的日志格式。[moby/moby#42838](https://github.com/moby/moby/pull/42838)
- 为 `fluentd` 日志驱动程序增加了一个新选项，用于设置重连间隔。[moby/moby#43100](https://github.com/moby/moby/pull/43100)
- 在 Go API 客户端中增加了新的选项设置器：`WithTLSClientConfigFromEnv()`、`WithHostFromEnv()` 和 `WithVersionFromEnv()`。[moby/moby#42224](https://github.com/moby/moby/pull/42224)
- 通过 `docker completion` 子命令增加了 shell 命令补全的生成功能。[docker/cli#3429](https://github.com/docker/cli/pull/3429)
- API：为 `GET /_ping` 和 `HEAD /_ping` 增加了 `Swarm` 标头，允许单次请求即可探测 Swarm 支持情况。[moby/moby#42064](https://github.com/moby/moby/pull/42064)
- API：为 `POST /containers/{id}/stop` 和 `POST /containers/{id}/restart` 增加了 `signal` 参数，用于设置所使用的信号。[moby/moby#43206](https://github.com/moby/moby/pull/43206)
- API：为 `POST /containers/create` 增加了 `CreateMountPoint` 参数。[moby/moby#43484](https://github.com/moby/moby/pull/43484)
- API：为 `GET /images/json` 增加了 `shared-size` 参数，以启用镜像的共享大小计算。[moby/moby#42531](https://github.com/moby/moby/pull/42531)
- API：为 `GET /system/df` 增加了 `type` 参数，用于控制在计算磁盘占用时考虑哪些对象类型。[moby/moby#42559](https://github.com/moby/moby/pull/42559)
- systemd：使用 systemd 管理的 containerd 代替守护进程管理的 containerd。[moby/moby#42373](https://github.com/moby/moby/pull/42373)
- systemd：在 `time-set.target` 之后启动 `docker.service`。[moby/moby#43107](https://github.com/moby/moby/pull/43107)

### 已移除

- 停止支持从 `~/.dockercfg` 读取配置。[docker/cli#2504](https://github.com/docker/cli/pull/2504)
  - 自 1.7.0 版本起，该路径已被弃用。
  - [弃用通知](../deprecated.md#support-for-legacy-dockercfg-configuration-files)
- 移除了 `-g` 和 `--graph` 守护进程标志，建议使用 `--data-root`。[docker/cli#3739](https://github.com/docker/cli/pull/3739)
  - 自 17.05 版本起，这些选项已被隐藏并弃用。
  - [弃用通知](../deprecated.md#-g-and---graph-flags-on-dockerd)
- 移除了结果的客户端排序，改为使用搜索 API 返回的顺序。[docker/cli#3470](https://github.com/docker/cli/pull/3470)
- 从 CLI 中移除了与已弃用存储驱动程序相关的警告。现在改为由守护进程处理警告。[docker/cli#3542](https://github.com/docker/cli/pull/3542)
- 从 `docker version` 中移除了 `Experimental` 客户端字段。[docker/cli#3543](https://github.com/docker/cli/pull/3543)
  - [弃用通知](../deprecated.md#configuration-options-for-experimental-cli-features)
- 使用已弃用的存储驱动程序时，需要显式选择启用，升级时不会再自动选择它们。[moby/moby#43378](https://github.com/moby/moby/pull/43378)
- 移除了针对不支持 `d_type` 的底层文件系统上 `overlay` 和 `overlay2` 存储驱动程序的已弃用支持。[moby/moby#43472](https://github.com/moby/moby/pull/43472)
  - [弃用通知](../deprecated.md#backing-filesystem-without-d_type-support-for-overlayoverlay2)
- 从 `overlay2` 存储驱动程序中移除了已弃用的 `overrideKernelCheck` 选项。[moby/moby#44279](https://github.com/moby/moby/pull/44279)
  [弃用通知](../deprecated.md#support-for-the-overlay2override_kernel_check-storage-option)
- 移除了对已弃用 `io.containerd.runtime.v1.linux` OCI 运行时的支持。[moby/moby#43695](https://github.com/moby/moby/pull/43695)
- 移除了 LCOW (Windows 上的 Linux 容器)。[moby/moby#42451](https://github.com/moby/moby/pull/42451), [moby/moby#42499](https://github.com/moby/moby/pull/42499), [moby/moby#42506](https://github.com/moby/moby/pull/42506), [moby/moby#42511](https://github.com/moby/moby/pull/42511), [moby/moby#42520](https://github.com/moby/moby/pull/42520), [moby/moby#42683](https://github.com/moby/moby/pull/42683), [moby/moby#42684](https://github.com/moby/moby/pull/42684), [moby/moby#42685](https://github.com/moby/moby/pull/42685), [moby/moby#43187](https://github.com/moby/moby/pull/43187)
  - LCOW 曾作为技术预览在 17.09 中引入，并在 20.10 中弃用。
  - [弃用通知](../deprecated.md#linux-containers-on-windows-lcow-experimental)
- 移除了与独立运行的 Swarm 配合使用的旧版 overlay 网络相关的守护进程选项。
  - 从 `dockerd` 中移除了 `--cluster-xx` 选项。[moby/moby#40383](https://github.com/moby/moby/issues/40383)
  - 移除了带有外部 k/v 存储的 `host-discovery` 和 overlay 网络。[moby/moby#42247](https://github.com/moby/moby/pull/42247)
  - [弃用通知](../deprecated.md#classic-swarm-and-overlay-networks-using-cluster-store)
- 移除了一个已弃用的 `arm` 平台回退机制。当 `arm/vY` 不可用时，`--platform linux/arm/vY` 现在将返回错误，而不是拉取错误的镜像。[moby/moby#44414](https://github.com/moby/moby/pull/44414)
- 从 Go 客户端 API 中移除了已弃用的 `SetCustomHTTPHeaders()`、`CustomHTTPHeaders()` 选项设置器。[moby/moby#42694](https://github.com/moby/moby/pull/42694)
- 从 Go 客户端 API 中移除了已弃用的 `WithDialer()` 选项设置器。[moby/moby#44022](https://github.com/moby/moby/pull/44022)
  - 请改用 `WithDialContext()`。
- 移除了 `opts.QuotedString` 的守护进程实现。该实现已移动到 CLI。[moby/moby#43250](https://github.com/moby/moby/pull/43250)
- 移除了守护进程中与 trust-key 分离的守护进程 ID，并禁用了 trust-key 的生成。[moby/moby#43555](https://github.com/moby/moby/pull/43555)
- API：在 API 版本 >= 1.42 中，从 `POST /containers/create` 中移除了已弃用的 `KernelMemory` 选项。[moby/moby#43214](https://github.com/moby/moby/pull/43214)
  - [弃用通知](../deprecated.md#kernel-memory-limit)

### 弃用

- 运行守护进程要求的最低 Windows 版本为 Windows Server RS5 / LTSC 2019 (build 17763)。[moby/moby#43254](https://github.com/moby/moby/pull/43254)
- 在 API 版本 >= 1.42 中弃用 `BuilderSize`。[moby/moby#42608](https://github.com/moby/moby/pull/42608)
- 在 API 版本 >= 1.42 中弃用 `BuildCache.Parent`，建议使用新引入的 `BuildCache.Parents`。[moby/moby#43908](https://github.com/moby/moby/pull/43908)
- 弃用 `pkg/urlutil`，将其实现移动到了 `builder/remotecontext/urlutil`。[moby/moby#43477](https://github.com/moby/moby/pull/43477)

### 升级

- 将 Go 更新至 `1.19.5`。[docker/cli#3958](https://github.com/docker/cli/pull/3958), [moby/moby#44794](https://github.com/moby/moby/pull/44794)
- 将 `rootlesskit` 更新至 `v0.14.4`。[moby/moby#42708](https://github.com/moby/moby/pull/42708)
- 将 `buildkit` 更新至 `v0.10.6`。[moby/moby#43239](https://github.com/moby/moby/pull/43239)
- 将 `buildx` 更新至 `v0.10.2`。[docker/docker-ce-packaging#840](https://github.com/docker/docker-ce-packaging/pull/840)
- 将 `swarmkit` 更新至 `v2.0.0-20230119195359-904c221ac281`。[moby/moby#44858](https://github.com/moby/moby/pull/44858)
- 将 `containerd` 更新至 `v1.6.16`。[moby/moby#44766](https://github.com/moby/moby/pull/44766), [moby/moby#44769](https://github.com/moby/moby/pull/44769), [moby/moby#44881](https://github.com/moby/moby/pull/44881)
- 将 `runc` 更新至 `v1.1.4`。[moby/moby#44039](https://github.com/moby/moby/pull/44039)
- 将 `hcsshim` 更新至 `v0.9.6`。[moby/moby#44658](https://github.com/moby/moby/pull/44658)
- `btrfs` 存储驱动程序现在依赖于 Linux 内核头文件 (>= 4.12)，而不是 btrfs-progs 的头文件。[moby/moby#44776](https://github.com/moby/moby/pull/44776)

### 安全

- 将容器 `hostconfig.json` 文件的权限更改为 `0600` (原为 `0644`)。[moby/moby#41620](https://github.com/moby/moby/pull/41620)
- 修复了 `--seccomp-profile` 不接受 `unconfined` 的问题，并将默认的 seccomp 配置文件重命名为 `builtin`。[moby/moby#42481](https://github.com/moby/moby/pull/42481)
- 始终在构建时包含 seccomp 支持，并移除了 `seccomp` 构建标记。[moby/moby#42501](https://github.com/moby/moby/pull/42501)
- 增加了对 `riscv64` 的 seccomp 支持。[moby/moby#43553](https://github.com/moby/moby/pull/43553)
- 增加了在 seccomp 配置文件中设置传递给 `seccomp(2)` 的标志的支持。[moby/moby#42648](https://github.com/moby/moby/pull/42648)
- 重构了 seccomp 类型以重用 runtime-spec，并增加了对 `ErrnoRet` 的支持。[moby/moby#42005](https://github.com/moby/moby/pull/42005)
- 在 `seccomp` 配置文件中增加了对 `DefaultErrnoRet` 的支持。[moby/moby#42604](https://github.com/moby/moby/pull/42604)
- 为默认 seccomp 配置文件增加了一个显式的 `DefaultErrnoRet` 字段，且没有行为变更。[moby/moby#42649](https://github.com/moby/moby/pull/42649)
- 在默认 seccomp 配置文件中屏蔽了 `socket` 搭配 `AF_VSOCK` 的用法。[moby/moby#44563](https://github.com/moby/moby/pull/44563)
- 在默认 seccomp 配置文件中重新启用了 `process_vm_readv` 和 `process_vm_writev`。[moby/moby#42083](https://github.com/moby/moby/pull/42083)
- 向默认 seccomp 配置文件增加了与 PKU 相关的系统调用。[moby/moby#43812](https://github.com/moby/moby/pull/43812)
- 允许在带有 `CAP_SYS_TIME` 的情况下使用 `clock_settime64`。[moby/moby#43775](https://github.com/moby/moby/pull/43775)
- 允许在带有 `CAP_BPF` 的情况下使用 `bpf`，以及在带有 `CAP_PERFMON` 的情况下使用 `perf_event_open`。[moby/moby#43988](https://github.com/moby/moby/pull/43988)
- 在默认 seccomp 配置文件中显式将 `clone3` 系统调用设置为返回 `ENOSYS`，以确保 `glibc` 能够正确回退到使用 `clone`。[moby/moby#42681](https://github.com/moby/moby/pull/42681)

### 错误修复与改进

- 提升 `overlay2` 为默认存储驱动程序 (`btrfs` 和 `zfs` 现在改为手动选择)。[moby/moby#42661](https://github.com/moby/moby/pull/42661)
- 为 `docker cp` 命令增加了加载动画。[docker/cli#2708](https://github.com/docker/cli/pull/2708)
- 弃用了 `ElectAuthServer` 函数，使其在不调用 `GET /info` API 端点的情况下返回默认注册表。[docker/cli#2819](https://github.com/docker/cli/pull/2819)
- 回滚 Swarm 服务时，进度条不再反向显示。[docker/cli#2940](https://github.com/docker/cli/pull/2940)
- 使用 `net.JoinHostPort()` 修复了 IPv6 地址的格式化问题。[docker/cli#2972](https://github.com/docker/cli/pull/2972)
- CLI 错误消息现在被打印到 `stderr`。[docker/cli#3044](https://github.com/docker/cli/pull/3044)
- 如果使用了仅需本地信息的自定义 `--format`，则会提高 `docker info` 的性能。通过此变更，CLI 仅在检测到需要守护进程的信息时才使用守护进程 API。[docker/cli#3179](https://github.com/docker/cli/pull/3179)
- 从 `--stop-signal` 标志中移除了默认值，因为它可能无法反映守护进程使用的实际默认值。[docker/cli#3245](https://github.com/docker/cli/pull/3245)
- 为 `docker stack` 增加了 Compose 模式 `3.10` 的支持；允许省略 `version` 字段 (将导致使用 `latest`)。[docker/cli#3257](https://github.com/docker/cli/pull/3257)
- 在 `docker stack` 中，Compose 版本 `3` 现在等同于 `3.x` (最新版)。[docker/cli#3445](https://github.com/docker/cli/pull/3445)
- 修复了在非交互模式下运行容器后，Windows 上的 `<Ctrl-c>` 无法正常退出挂起的问题。[docker/cli#3302](https://github.com/docker/cli/pull/3302)
- 在 `run` 命令的 `-v`/`--volume` 和 `-m`/`--mount` 标志中增加了相对源路径支持。[docker/cli#3469](https://github.com/docker/cli/pull/3469)
- `docker exec -t` 现在在执行进程创建时立即设置控制台大小。[docker/cli#3627](https://github.com/docker/cli/pull/3627)
- 更新了 `docker info` 的美化打印格式，以提供更多已安装插件的细节。[docker/cli#3645](https://github.com/docker/cli/pull/3645)
- 当上下文 (context) 被环境变量覆盖时，为 `docker context list` 和 `docker context use` 命令打印警告消息。[docker/cli#3668](https://github.com/docker/cli/pull/3668)
- 增加了自定义的 `aliases` 注释，可用于打印命令的所有可用别名。[docker/cli#3694](https://github.com/docker/cli/pull/3694)
- 运行 `docker context use` 并选择当前上下文时，CLI 不再创建或更新 CLI 配置文件。[docker/cli#3721](https://github.com/docker/cli/pull/3721)
- 运行 `docker context rm --force` 时，现在会忽略不存在的上下文。[docker/cli#3791](https://github.com/docker/cli/pull/3791)
- 在 Compose 文件中增加了将整数重写为 `0` 的能力。[docker/cli#3812](https://github.com/docker/cli/pull/3812)
- SIGINT (`<Ctrl-c>`) 现在会传递给正在运行的容器，而不是导致 CLI 退出。[docker/cli#3849](https://github.com/docker/cli/pull/3849)
- 通过在打印前对端口进行排序，改进了 `docker port CONTAINER` 的体验。[docker/cli#3892](https://github.com/docker/cli/pull/3892)
- API：在 API 版本 >= 1.42 中，`GET /containers/{id}/logs` 和 `POST /containers/{id}/attach` 现在通过 `Content-type` 响应头报告正在使用的原始流格式。[moby/moby#39812](https://github.com/moby/moby/pull/39812)
- 将 Windows 层的默认沙箱大小设置为 127GB，并确保 `--storage-opts` 标志适用于 Windows 上的所有存储。[moby/moby#41636](https://github.com/moby/moby/pull/41636)
- 从 containerd 配置文件 (`/var/run/docker/containerd/containerd.toml`) 中移除了插件部分。[moby/moby#41675](https://github.com/moby/moby/pull/41675)
- 焦油 (tar) 导入期间拒绝 `null` 清单。[moby/moby#41842](https://github.com/moby/moby/pull/41842)
- 为插件的自定义运行时增加了 shim 配置。[moby/moby#41854](https://github.com/moby/moby/pull/41854)
- 当守护进程重启时，容器健康检查现在会恢复运行。[moby/moby#41935](https://github.com/moby/moby/pull/41935)
- 清理 `btrfs` 驱动程序时不再禁用配额。[moby/moby#42273](https://github.com/moby/moby/pull/42273)
- 可访问的主机设备现在可以在 `--privileged` 无根容器中挂载。[moby/moby#42638](https://github.com/moby/moby/pull/42638)
- 修复了 `.dockerignore` 中 `**/foo` 递归通配符目录模式处理不正确的问题。[moby/moby#42676](https://github.com/moby/moby/pull/42676)
- 扩展了 `docker import --platform`，允许将导入的镜像标记为外部架构。[moby/moby#43103](https://github.com/moby/moby/pull/43103)
- CPU 实时选项的验证现在在守护进程启动时执行，而不是为每个单独容器执行验证，从而允许及早发现启动失败。[moby/moby#43131](https://github.com/moby/moby/pull/43131)
- 冻结了 `namesgenerator` 包，不再接受新的添加。用户必须满足于现有的 25359 个形容词-名词组合。[moby/moby#43210](https://github.com/moby/moby/pull/43210)
- API：在 API 版本 >= 1.42 中，`containers/{id}/attach/ws` 仅根据 `stdin`、`stdout` 和 `stderr` 参数进行流连接。[moby/moby#43322](https://github.com/moby/moby/pull/43322)
- 修复了容器在持续流量下重启后 UDP 流量无法正常工作的问题。[moby/moby#43409](https://github.com/moby/moby/pull/43409)
- 增加了对拉取具有自定义 amd64 微架构功能级别的镜像的支持，这些功能级别由最新版本的 Go、GCC、LLVM 和其他编译器工具支持。[moby/moby#43434](https://github.com/moby/moby/pull/43434)
- 改进了 API 中对无效 JSON 请求的验证。[moby/moby#43463](https://github.com/moby/moby/pull/43463)
- 减轻了慢速 `exec` 启动对健康检查的影响。检查超时现在仅适用于健康检查命令运行的持续时间。启动命令所花费的时间不再计入超时。[moby/moby#43480](https://github.com/moby/moby/pull/43480)
- 控制台 `tty` 大小在创建时立即设置。[moby/moby#43593](https://github.com/moby/moby/pull/43593), [moby/moby#43622](https://github.com/moby/moby/pull/43622)
- 修复了在容器启动失败或守护进程关闭后 `overlay2` 挂载未被清理的问题。[moby/moby#43659](https://github.com/moby/moby/pull/43659)
- 将清单列表解析与 `containerd` 对齐。[moby/moby#43675](https://github.com/moby/moby/pull/43675)
- 当守护进程在无根模式下运行时，跳过对联网使用 `firewalld`。[moby/moby#43813](https://github.com/moby/moby/pull/43813)
- Windows 上如果缺失自定义 NAT 网络，在守护进程重启后现在会自动重新创建。[moby/moby#43858](https://github.com/moby/moby/pull/43858)
- 修复了容器健康检查进程在超时时未被终止的问题。[moby/moby#43994](https://github.com/moby/moby/pull/43994)
- 修复了带有重启策略和卷引用的 `live-restore` 问题。[moby/moby#44237](https://github.com/moby/moby/pull/44237)
- API：在 API 版本 >= v1.42 中，默认仅清理匿名卷。通过传递 `all=true` 过滤器来清理除匿名卷以外的具名卷。[moby/moby#44259](https://github.com/moby/moby/pull/44259)
- API：支持并发调用 `GET /system/df` 端点。[moby/moby#42715](https://github.com/moby/moby/pull/42715)
- 提高了守护进程在接收到 SIGQUIT 时转储堆栈并以状态码 2 退出的可靠性。[moby/moby#44831](https://github.com/moby/moby/pull/44831)
- 提高了 Windows 上 `docker logs -f` 的可靠性，并防止在 `local` 日志驱动程序中丢失换行符。[moby/moby#43294](https://github.com/moby/moby/pull/43294)
- 修复了由容器日志缓冲引起的守护进程中罕见的死锁。[moby/moby#44856](https://github.com/moby/moby/pull/44856)
- 改进了杂项文件系统操作中的错误处理，使守护进程可以在 overlayfs 底层文件系统上启动。[moby/moby#44834](https://github.com/moby/moby/pull/44834)
- 修复了当守护进程在无根模式下运行时 `--ipc=host` 未被正确处理的问题。[moby/moby#44863](https://github.com/moby/moby/pull/44863)
- 修复了一系列长期存在的问题，其中陈旧的 conntrack 条目导致容器 UDP 流量路由错误。[moby/moby#44752](https://github.com/moby/moby/pull/44752)
- 修复了半注册容器被列在 API 中的问题，以及由 API 调用中使用部分注册的容器引起的空指针引用和崩溃 (panic)。[moby/moby#44633](https://github.com/moby/moby/pull/44633)
- 修复了无法创建 `DOCKER-USER` ip6tables 链的问题。[moby/moby#44845](https://github.com/moby/moby/pull/44845)
- 修复了在 `ip6tables` 命令不可用时无法清理 iptables 规则的问题。[moby/moby#44727](https://github.com/moby/moby/pull/44727)
- 修复了启用用户空间代理后某些 iptables NAT 规则未被清理的问题。[moby/moby#44811](https://github.com/moby/moby/pull/44811)
- 修复了在处理启动容器失败的清理过程中，极少数情况下可能出现的泄露进程问题。[moby/moby#44400](https://github.com/moby/moby/pull/44400)
- 修复了卷的 `CreatedAt` 时间反映的是初始化时间而非创建时间的问题。[moby/moby#44725](https://github.com/moby/moby/pull/44725)
- 修复了 CLI 在某些命令中错误地报告服务器不兼容而非服务器不可达的问题。[docker/cli#3901](https://github.com/docker/cli/pull/3901), [docker/cli#3904](https://github.com/docker/cli/pull/3904)
- 修复了 Zsh 中损坏的卷补全问题。[docker/cli#2998](https://github.com/docker/cli/pull/2998)
- 改进了存在无效上下文时的 `docker context` 输出。[docker/cli#3847](https://github.com/docker/cli/pull/3847)
- 当输出不是 TTY 时，移除了 CLI 帮助注释的 ANSI 修饰，并为了可读性添加了换行符。[docker/cli#3973](https://github.com/docker/cli/pull/3973)
- 将 `docker container remove` 添加为 `docker container rm` 的别名。[docker/cli#3986](https://github.com/docker/cli/pull/3986)

### 已知问题

#### apparmor_parser ([追踪问题](https://github.com/moby/moby/issues/44900))

一些 Debian 用户报告了升级到 23.0 分支后容器启动失败的问题。错误消息表明问题是由于缺少 `apparmor_parser` 二进制文件引起的：

```console
Error response from daemon: AppArmor enabled on system but the docker-default profile could not be loaded: running `apparmor_parser apparmor_parser --version` failed with output:
error: exec: "apparmor_parser": executable file not found in $PATH
Error: failed to start containers: somecontainer
```

此问题的解决方法是手动安装 `apparmor` 软件包：

```console
apt-get install apparmor
```

#### BuildKit 内联缓存 (inline cache) ([追踪问题](https://github.com/moby/moby/issues/44918))

尝试使用 BuildKit 的内联缓存功能进行构建 (例如 `docker build --build-arg BUILDKIT_INLINE_CACHE=1 .`, `docker buildx build --cache-to type=inline .`) 将导致守护进程意外退出：

```
panic: runtime error: invalid memory address or nil pointer dereference
[signal SIGSEGV: segmentation violation code=0x1 addr=0x18 pc=0x147ff00]

goroutine 693 [running]:
github.com/docker/docker/vendor/github.com/moby/buildkit/cache.computeBlobChain.func4.1({0x245cca8, 0x4001394960})
        /go/src/github.com/docker/docker/vendor/github.com/moby/buildkit/cache/blobs.go:206 +0xc90
github.com/docker/docker/vendor/github.com/moby/buildkit/util/flightcontrol.(*call).run(0x40013c2240)
        /go/src/github.com/docker/docker/vendor/github.com/moby/buildkit/util/flightcontrol/flightcontrol.go:121 +0x64
sync.(*Once).doSlow(0x0?, 0x4001328240?)
        /usr/local/go/src/sync/once.go:74 +0x100
sync.(*Once).Do(0x4001328240?, 0x0?)
        /usr/local/go/src/sync/once.go:65 +0x24
created by github.com/docker/docker/vendor/github.com/moby/buildkit/util/flightcontrol.(*call).wait
```

发生此类崩溃后，如果配置了重启 (例如通过 systemd)，守护进程将重启。此版本中唯一的缓解措施是避免执行启用了内联缓存功能的构建。

#### 带有热缓存 (warm cache) 的 BuildKit ([追踪问题](https://github.com/moby/moby/issues/44943))

如果镜像是使用先前版本的守护进程在 BuildKit 下构建的，并且使用 23.0 版本的守护进程进行构建，则之前缓存的层将无法正确还原。如果 Dockerfile 中没有更改任何行，镜像可能看起来构建正确；然而，如果由于更改了 Dockerfile 中的某些行而发生部分缓存失效，之前仍有效且已缓存的层将无法正确加载。

这通常表现为在更改 Dockerfile 中的某些行后，镜像中本应存在的文件在 `RUN` 阶段或任何引用文件的阶段中不存在：

```
[+] Building 0.4s (6/6) FINISHED
 => [internal] load build definition from Dockerfile
 => => transferring dockerfile: 102B
 => [internal] load .dockerignore
 => => transferring context: 2B
 => [internal] load metadata for docker.io/library/node:18-alpine
 => [base 1/2] FROM docker.io/library/node:18-alpine@sha256:bc329c7332cffc30c2d4801e38df03cbfa8dcbae2a7a52a449db104794f168a3
 => CACHED [base 2/2] WORKDIR /app
 => ERROR [stage-1 1/1] RUN uname -a
------
 > [stage-1 1/1] RUN uname -a:
#0 0.138 runc run failed: unable to start container process: exec: "/bin/sh": stat /bin/sh: no such file or directory
------
Dockerfile:5
--------------------
   3 |
   4 |     FROM base
   5 | >>> RUN uname -a
   6 |
--------------------
ERROR: failed to solve: process "/bin/sh -c uname -a" did not complete successfully: exit code: 1
```

要缓解此问题，必须丢弃之前的构建缓存。`docker builder prune -a` 将完全清空构建缓存，并允许受影响的构建通过移除错误处理的缓存层而重新进行。

#### ipvlan 网络 ([追踪问题](https://github.com/moby/moby/issues/44925))

当升级到 23.0 分支时，任何 [ipvlan](/manuals/engine/network/drivers/ipvlan.md) 网络的存在都将阻止守护进程启动：

```
panic: interface conversion: interface {} is nil, not string

goroutine 1 [running]:
github.com/docker/docker/libnetwork/drivers/ipvlan.(*configuration).UnmarshalJSON(0x40011533b0, {0x400069c2d0, 0xef, 0xef})
        /go/src/github.com/docker/docker/libnetwork/drivers/ipvlan/ipvlan_store.go:196 +0x414
encoding/json.(*decodeState).object(0x4001153440, {0x5597157640?, 0x40011533b0?, 0x559524115c?})
        /usr/local/go/src/encoding/json/decode.go:613 +0x650
encoding/json.(*decodeState).value(0x4001153440, {0x5597157640?, 0x40011533b0?, 0x559524005c?})
        /usr/local/go/src/encoding/json/decode.go:374 +0x40
encoding/json.(*decodeState).unmarshal(0x4001153440, {0x5597157640?, 0x40011533b0?})
        /usr/local/go/src/encoding/json/decode.go:181 +0x204
encoding/json.Unmarshal({0x400069c2d0, 0xef, 0xef}, {0x5597157640, 0x40011533b0})
        /usr/local/go/src/encoding/json/decode.go:108 +0xf4
github.com/docker/docker/libnetwork/drivers/ipvlan.(*configuration).SetValue(0x4000d18050?, {0x400069c2d0?, 0x23?, 0x23?})
        /go/src/github.com/docker/docker/libnetwork/drivers/ipvlan/ipvlan_store.go:230 +0x38
```

要缓解此问题，受影响的用户可以降级并移除网络，然后再次升级。或者，可以移除整个网络存储，并在升级后重新创建网络。网络存储位于 `/var/lib/docker/network/files/local-kv.db`。如果守护进程使用了备选的 `--data-root`，请将 `/var/lib/docker` 替换为该备选路径。

#### Kata Containers ([追踪问题](https://github.com/kata-containers/kata-containers/issues/6154))

23.0 分支带来了对替代 containerd shims 的支持，如 `io.containerd.runsc.v1` (gVisor) 和 `io.containerd.kata.v2` (Kata Containers)。

当使用 Kata Containers 运行时，退出 `exec` 会话会停止正在运行的容器，且如果开启了 TTY，则会挂起连接的 CLI。目前除了避免 exec 到运行在 Kata 运行时上的容器外，没有其他缓解措施。

此问题的根源在于 Moby 中一个长期存在的 bug。这将在未来的版本中得到解决。请注意，对替代 OCI 运行时的支持是一项新功能，随着更多用户开始使用此功能，可能会发现类似的问题。
