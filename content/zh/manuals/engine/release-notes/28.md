---
title: Docker Engine 28 版发布说明
linkTitle: Engine v28
description: 了解 Docker Engine 28 版的新功能、错误修复和重大变更
keywords: docker, docker engine, ce, whats new, release notes, 发布说明
toc_min: 1
toc_max: 2
tags:
  - Release notes
aliases:
- /engine/release-notes/
- /engine/release-notes/latest/
- /release-notes/docker-ce/
- /release-notes/docker-engine/
- /engine/release-notes/28.0/
- /engine/release-notes/28.1/
---

本页描述了 Docker Engine 28 版的最新变更、新增内容、已知问题和修复。

有关以下内容的更多信息：

- 已弃用和已移除的功能，请参阅 [已弃用的 Engine 功能](../deprecated.md)。
- Engine API 的变更，请参阅 [Engine API 版本历史](/reference/api/engine/version-history.md)。

## 28.3.1

{{< release-date date="2025-07-02" >}}

有关此版本中拉取请求 (PR) 和变更的完整列表，请参考相关的 GitHub 里程碑：

- [docker/cli, 28.3.1 里程碑](https://github.com/docker/cli/issues?q=is%3Aclosed+milestone%3A28.3.1)
- [moby/moby, 28.3.1 里程碑](https://github.com/moby/moby/issues?q=is%3Aclosed+milestone%3A28.3.1)

### 打包更新

- 将 BuildKit 更新至 [v0.23.2](https://github.com/moby/buildkit/releases/tag/v0.23.2)。[moby/moby#50309](https://github.com/moby/moby/pull/50309)
- 将 Compose 更新至 [v2.38.1](https://github.com/docker/compose/releases/tag/v2.38.1)。[docker/docker-ce-packaging#1221](https://github.com/docker/docker-ce-packaging/pull/1221)
- 将 Model 更新至 v0.1.32，增加了对 Docker Compose 中新的顶级 `models:` 键的支持。[docker/docker-ce-packaging#1222](https://github.com/docker/docker-ce-packaging/pull/1222)

## 28.3.0

{{< release-date date="2025-06-24" >}}

有关此版本中拉取请求 (PR) 和变更的完整列表，请参考相关的 GitHub 里程碑：

- [docker/cli, 28.3.0 里程碑](https://github.com/docker/cli/issues?q=is%3Aclosed+milestone%3A28.3.0)
- [moby/moby, 28.3.0 里程碑](https://github.com/moby/moby/issues?q=is%3Aclosed+milestone%3A28.3.0)

### 新增功能

- 在 `docker run --gpus` 中添加对 AMD GPU 的支持。[moby/moby#49952](https://github.com/moby/moby/pull/49952)
- 支持使用 `DOCKER_AUTH_CONFIG` 作为凭据存储。[docker/cli#6008](https://github.com/docker/cli/pull/6008)

### 错误修复与改进

- 确保在使用 [/containers/{id}/stop](https://docs.docker.com/reference/api/engine/version/v1.49/#tag/Container/operation/ContainerStop) API 停止容器时，守护进程数据库中的容器状态 (由 [/containers/json](https://docs.docker.com/reference/api/engine/version/v1.49/#tag/Container/operation/ContainerList) API 使用) 是最新的 (在 API 响应之前)。[moby/moby#50136](https://github.com/moby/moby/pull/50136)
- 修复 `docker image inspect inspect` 遗漏空字段的问题。[moby/moby#50135](https://github.com/moby/moby/pull/50135)
- 修复在禁用 containerd 镜像存储时，`docker images --tree` 未将镜像标记为“使用中”的问题。[docker/cli#6140](https://github.com/docker/cli/pull/6140)
- 修复在非交互模式下需要身份验证时，由于提示输入登录凭据导致 `docker pull/push` 挂起的问题。[docker/cli#6141](https://github.com/docker/cli/pull/6141)
- 修复当节点离开 Swarm 时可能发生的资源泄漏。[moby/moby#50115](https://github.com/moby/moby/pull/50115)
- 修复了一个回归问题，即 `docker pull` 上的登录提示在登录其他注册表时会显示 Docker Hub 特有的提示。[docker/cli#6135](https://github.com/docker/cli/pull/6135)
- 修复了在向上扩展具有放置偏好的服务后，Swarm 中的所有新任务可能会永远卡在 PENDING 状态的问题。[moby/moby#50211](https://github.com/moby/moby/pull/50211)
- 移除了在 Docker 23.0 中意外引入的一个未记录、隐藏的顶级 `docker remove` 命令。[docker/cli#6144](https://github.com/docker/cli/pull/6144)
- 在 `dockerd --validate` 中验证 `registry-mirrors` 配置，并改进无效镜像源的错误消息。[moby/moby#50240](https://github.com/moby/moby/pull/50240)
- `dockerd-rootless-setuptool.sh`：修复当不满足 subuid/subgid 系统要求时，脚本静默返回且无错误消息的问题。[moby/moby#50059](https://github.com/moby/moby/pull/50059)
- containerd 镜像存储：修复 `docker push` 不在远程仓库创建标签的问题。[moby/moby#50199](https://github.com/moby/moby/pull/50199)
- containerd 镜像存储：改进 `docker pull/push` 期间对令牌服务器返回错误的各种处理。[moby/moby#50176](https://github.com/moby/moby/pull/50176)

### 打包更新

- 允许为 OpenRC 自定义 containerd 服务名称。[moby/moby#50156](https://github.com/moby/moby/pull/50156)
- 将 BuildKit 更新至 [v0.23.1](https://github.com/moby/buildkit/releases/tag/v0.23.1)。[moby/moby#50243](https://github.com/moby/moby/pull/50243)
- 将 Buildx 更新至 [v0.25.0](https://github.com/docker/buildx/releases/tag/v0.25.0)。[docker/docker-ce-packaging#1217](https://github.com/docker/docker-ce-packaging/pull/1217)
- 将 Compose 更新至 [v2.37.2](https://github.com/docker/compose/releases/tag/v2.37.2)。[docker/docker-ce-packaging#1219](https://github.com/docker/docker-ce-packaging/pull/1219)
- 将 Docker Model CLI 插件更新至 [v0.1.30](https://github.com/docker/model-cli/releases/tag/v0.1.30)。[docker/docker-ce-packaging#1218](https://github.com/docker/docker-ce-packaging/pull/1218)
- 将 Go 运行时更新至 [1.24.4](https://go.dev/doc/devel/release#go1.24.4)。[docker/docker-ce-packaging#1213](https://github.com/docker/docker-ce-packaging/pull/1213), [moby/moby#50153](https://github.com/moby/moby/pull/50153), [docker/cli#6124](https://github.com/docker/cli/pull/6124)

### 联网

- 还原了 28.2.x 版本中添加的 Swarm 相关变更，原因是 https://github.com/moby/moby/issues/50129 中报告的回归。[moby/moby#50169](https://github.com/moby/moby/pull/50169)
  * 还原：修复 `docker network inspect --verbose` 有时可能导致守护进程崩溃的问题 (https://github.com/moby/moby/pull/49937)。
  * 还原：修复在 Swarm 缺少 ingress 网络时，某些情况下 overlay 网络的负载均衡器 IP 地址不会被释放的问题 (https://github.com/moby/moby/pull/49948)。
  * 还原：提高了繁忙集群和有损网络中 NetworkDB 的可靠性 (https://github.com/moby/moby/pull/49932)。
  * 还原：改进了 NetworkDB 的可靠性和收敛速度 (https://github.com/moby/moby/pull/49939)。
- 修复当某些容器端口映射到 `0.0.0.0` 而另一些映射到特定主机地址时，可能导致容器启动失败或 UDP 端口映射失败的问题。[moby/moby#50054](https://github.com/moby/moby/pull/50054)
- overlay 网络的 `network inspect` 响应现在报告 `EnableIPv4` 为 true。[moby/moby#50147](https://github.com/moby/moby/pull/50147)
- Windows：改进了主机具有 `"Mirrored"` 类型网络时守护进程的启动时间。[moby/moby#50155](https://github.com/moby/moby/pull/50155)
- Windows：确保 `docker system prune` 和 `docker network prune` 仅移除由 Docker 创建的网络。[moby/moby#50154](https://github.com/moby/moby/pull/50154)

### API

- 将 API 版本更新为 1.51。[moby/moby#50145](https://github.com/moby/moby/pull/50145)
- `GET /images/json` 现在将所有镜像的 `Containers` 字段值设置为使用该镜像的容器计数。[moby/moby#50146](https://github.com/moby/moby/pull/50146)

### 弃用

- `GET /images/{name}/json` 响应中的空/nil 镜像配置字段现已弃用，并将在 v29.0 中移除。[docker/cli#6129](https://github.com/docker/cli/pull/6129)
- api/types/container：弃用 `ExecOptions.Detach`。此字段未使用，将在未来版本中移除。[moby/moby#50219](https://github.com/moby/moby/pull/50219)
- pkg/idtools：弃用 `IdentityMapping` 和 `Identity.Chown`。[moby/moby#50210](https://github.com/moby/moby/pull/50210)

## 28.2.2

{{< release-date date="2025-05-30" >}}

有关此版本中拉取请求 (PR) 和变更的完整列表，请参考相关的 GitHub 里程碑：

- [docker/cli, 28.2.2 里程碑](https://github.com/docker/cli/issues?q=is%3Aclosed+milestone%3A28.2.2)
- [moby/moby, 28.2.2 里程碑](https://github.com/moby/moby/issues?q=is%3Aclosed+milestone%3A28.2.2)

### 错误修复与改进

- containerd 镜像存储：修复导致 `docker build --push` 失败的回归。这还原了对 `docker build` 不将覆盖的镜像持久化为悬空镜像的 [修复](https://github.com/moby/moby/pull/49702)。[moby/moby#50105](https://github.com/moby/moby/pull/50105)

### 联网

- 创建 iptables `DOCKER-USER` 链时，不再添加显式的 `RETURN` 规则，允许用户追加以及插入自己的规则。升级时不会移除现有规则，但在重启后不会被替换。[moby/moby#50098](https://github.com/moby/moby/pull/50098)

## 28.2.1

{{< release-date date="2025-05-29" >}}

## 打包更新

- 修复 [v28.2.0](https://github.com/moby/moby/releases/tag/v28.2.0) 中的打包回归，该回归导致新安装时无法创建 `docker` 组/用户。[docker-ce-packaging#1209](https://github.com/docker/docker-ce-packaging/issues/1209)

## 28.2.0

{{< release-date date="2025-05-28" >}}

有关此版本中拉取请求 (PR) 和变更的完整列表，请参考相关的 GitHub 里程碑：

- [docker/cli, 28.2.0 里程碑](https://github.com/docker/cli/issues?q=is%3Aclosed+milestone%3A28.2.0)
- [moby/moby, 28.2.0 里程碑](https://github.com/moby/moby/issues?q=is%3Aclosed+milestone%3A28.2.0)

> [!NOTE]
> RHEL 软件包目前不可用，稍后发布。

### 新增功能

- 为 `docker ps` 添加 `{{.Platform}}` 格式化选项，以显示容器运行镜像的平台。[docker/cli#6042](https://github.com/docker/cli/pull/6042)
- 当在 `docker run/create` 中使用 `-v/--volume` 或 `--mount type=bind` 选项时，支持在绑定挂载源中使用相对父路径 (`../`)。[docker/cli#4966](https://github.com/docker/cli/pull/4966)
- CDI 现在默认启用。[moby/moby#49963](https://github.com/moby/moby/pull/49963)
- 在 `docker info` 中显示发现的 CDI 设备。[docker/cli#6078](https://github.com/docker/cli/pull/6078)
- `docker image rm`：添加 `--platform` 选项以从多平台镜像中移除特定变体。[docker/cli#6109](https://github.com/docker/cli/pull/6109)
- containerd 镜像存储：BuildKit 初步支持在 Windows 上构建 Windows 容器镜像 (需要通过 `DOCKER_BUILDKIT=1` 选择启用)。[moby/moby#49740](https://github.com/moby/moby/pull/49740)

### 错误修复与改进

- 为 fluentd 日志驱动程序添加了一个新的日志选项 (`fluentd-write-timeout`)，支持指定 fluentd 连接的写入超时时间。[moby/moby#49911](https://github.com/moby/moby/pull/49911)
- 为实验性的 `--use-api-socket` 选项添加对 `DOCKER_AUTH_CONFIG` 的支持。[docker/cli#6019](https://github.com/docker/cli/pull/6019)
- 修复如果指定了不存在的用户或组，`docker exec` 会等待 10 秒的问题。[moby/moby#49868](https://github.com/moby/moby/pull/49868)
- 修复 `docker swarm init` 忽略 `--external-ca` 的 `cacert` 选项的问题。[docker/cli#5995](https://github.com/docker/cli/pull/5995)
- 修复如果配置文件 (`~/.docker/config.json`) 是相对符号链接，CLI 无法正确保存该文件的问题。[docker/cli#5282](https://github.com/docker/cli/pull/5282)
- 修复使用 CDI 设备的带有 `--restart always` 策略的容器在守护进程重启后启动失败的问题。[moby/moby#49990](https://github.com/moby/moby/pull/49990)
- 修复 shell 补全，使其对某些标志仅补全一次，尽管它们可以设置多次。[docker/cli#6030](https://github.com/docker/cli/pull/6030)
- 修复 Swarm CSI 驱动程序的 `plugin does not implement PluginAddr interface` 错误。[moby/moby#49961](https://github.com/moby/moby/pull/49961)
- 改进 `docker login` 对于无效选项的错误消息。[docker/cli#6036](https://github.com/docker/cli/pull/6036)
- 确保如果 CLI 被强制终止，终端状态会被恢复。[docker/cli#6058](https://github.com/docker/cli/pull/6058)
- 更新默认 seccomp 配置文件以匹配 libseccomp v2.6.0。新系统调用包括：`listmount`、`statmount`、`lsm_get_self_attr`、`lsm_list_modules`、`lsm_set_self_attr`、`mseal`、`uretprobe`、`riscv_hwprobe`、`getxattrat`、`listxattrat`、`removexattrat` 和 `setxattrat`。这可以防止容器在运行这些调用时收到 EPERM 错误。[moby/moby#50077](https://github.com/moby/moby/pull/50077)
- `docker inspect`：添加 shell 补全，改进 `--type` 的标志描述并改进验证。[docker/cli#6052](https://github.com/docker/cli/pull/6052)
- containerd 镜像存储：默认启用 BuildKit 垃圾回收器。[moby/moby#49899](https://github.com/moby/moby/pull/49899)
- containerd 镜像存储：修复 `docker build` 不将覆盖的镜像持久化为悬空镜像的问题。[moby/moby#49702](https://github.com/moby/moby/pull/49702)
- containerd 镜像存储：修复 `docker system df` 报告负数的可回收空间量的问题。[moby/moby#49707](https://github.com/moby/moby/pull/49707)
- containerd 镜像存储：修复在推送多平台镜像时的重复 `PUT` 请求。[moby/moby#49949](https://github.com/moby/moby/pull/49949)

### 打包更新

- 停止提供 Ubuntu 20.04 "Focal" 软件包，因为它已达到生命周期终点。[docker/docker-ce-packaging#1200](https://github.com/docker/docker-ce-packaging/pull/1200)
- 修复基于 RPM 的 `docker-ce` 手册页 (man-pages) 的安装位置。[docker/docker-ce-packaging#1203](https://github.com/docker/docker-ce-packaging/pull/1203)
- 将 BuildKit 更新至 [v0.22.0](https://github.com/moby/buildkit/releases/tag/v0.22.0)。[moby/moby#50046](https://github.com/moby/moby/pull/50046)
- 将 Buildx 更新至 [v0.24.0](https://github.com/docker/buildx/releases/tag/v0.24.0)。[docker/docker-ce-packaging#1205](https://github.com/docker/docker-ce-packaging/pull/1205)
- 将 Compose 更新至 [v2.36.2](https://github.com/docker/compose/releases/tag/v2.36.2)。[docker/docker-ce-packaging#1208](https://github.com/docker/docker-ce-packaging/pull/1208)
- 将 Go 运行时更新至 [1.24.3](https://go.dev/doc/devel/release#go1.24.3)。[docker/docker-ce-packaging#1192](https://github.com/docker/docker-ce-packaging/pull/1192), [docker/cli#6060](https://github.com/docker/cli/pull/6060), [moby/moby#49174](https://github.com/moby/moby/pull/49174)

### 联网

- 添加桥接网络选项 `"com.docker.network.bridge.trusted_host_interfaces"`，接受以冒号分隔的接口名称列表。这些接口可以直接访问容器 IP 地址上的发布端口。[moby/moby#49832](https://github.com/moby/moby/pull/49832)
- 添加守护进程选项 `"allow-direct-routing"`，以禁用对来自主机外部直接发往容器的数据包的过滤。[moby/moby#49832](https://github.com/moby/moby/pull/49832)
- 如果 `EnableIPv4` 或 `EnableIPv6` 在网络创建请求中已被覆盖，则在 inspect 输出中不再显示网络选项 `com.docker.network.enable_ipv4` 或 `com.docker.network.enable_ipv6`。[moby/moby#49866](https://github.com/moby/moby/pull/49866)
- 修复一个问题，该问题可能导致在守护进程重启后网络删除失败，报错 "has active endpoints" 且列出的端点名称为空。[moby/moby#49901](https://github.com/moby/moby/pull/49901)
- 修复 `docker network inspect --verbose` 有时可能导致守护进程崩溃的问题。[moby/moby#49937](https://github.com/moby/moby/pull/49937)
- 修复在 Swarm 缺少 ingress 网络时，某些情况下 overlay 网络的负载均衡器 IP 地址不会被释放的问题。[moby/moby#49948](https://github.com/moby/moby/pull/49948)
- 提高在繁忙集群和有损网络中 NetworkDB 的可靠性。[moby/moby#49932](https://github.com/moby/moby/pull/49932)
- 改进 NetworkDB 的可靠性和收敛速度。[moby/moby#49939](https://github.com/moby/moby/pull/49939)

### API

- `DELETE /images/{name}` 现在支持 `platforms` 查询参数。它接受 JSON 编码的 OCI Platform 对象数组，允许选择特定平台进行内容删除。[moby/moby#49982](https://github.com/moby/moby/pull/49982)
- `GET /info` 现在包含一个 `DiscoveredDevices` 字段。这是一个 `DeviceInfo` 对象数组，每个对象提供由设备驱动程序发现的设备的详细信息。[moby/moby#49980](https://github.com/moby/moby/pull/49980)

### Go SDK

- `api/types/container`：添加 `ContainerState` 及容器状态常量。[moby/moby#49965](https://github.com/moby/moby/pull/49965)
- `api/types/container`：将 `Summary.State` 更改为 `ContainerState` 类型。[moby/moby#49991](https://github.com/moby/moby/pull/49991)
- `api/types/container`：为健康状态常量定义 `HealthStatus` 类型。[moby/moby#49876](https://github.com/moby/moby/pull/49876)
- `api/types`：弃用 `BuildResult`、`ImageBuildOptions`、`ImageBuildOutput`、`ImageBuildResponse`、`BuilderVersion`、`BuilderV1` 和 `BuilderBuildKi`，它们已移至 `api/types/build`。[moby/moby#50025](https://github.com/moby/moby/pull/50025)

### 弃用

- API：弃用：`GET /images/{name}/json` 不再返回以下字段：`Config`、`Hostname`、`Domainname`、`AttachStdin`、`AttachStdout`、`AttachStderr`、`Tty`、`OpenStdin`、`StdinOnce`、`Image`、`NetworkDisabled` (除非设置，否则已省略)、`MacAddress` (除非设置，否则已省略)、`StopTimeout` (除非设置，否则已省略)。由于实现细节，这些额外字段包含在响应中，但不属于镜像配置的一部分，它们已在 API v1.46 中标记为弃用，现在被省略。[moby/moby#48457](https://github.com/moby/moby/pull/48457)
- Go-SDK：弃用 builder/remotecontext.Rel()。此函数在旧版 Go 中需要，现在可以用 `filepath.Rel()` 替换。[moby/moby#49843](https://github.com/moby/moby/pull/49843)
- Go-SDK：api/types：弃用 `BuildCachePruneOptions`，建议使用 `api/types/builder.CachePruneOptions`。[moby/moby#50015](https://github.com/moby/moby/pull/50015)
- Go-SDK：api/types：弃用 `BuildCachePruneReport`，建议使用 `api/types/builder.CachePruneReport`。[moby/moby#50015](https://github.com/moby/moby/pull/50015)
- Go-SDK：api/types：弃用 `NodeListOptions`、`NodeRemoveOptions`、`ServiceCreateOptions`、`ServiceUpdateOptions`、`RegistryAuthFromSpec`、`RegistryAuthFromPreviousSpec`、`ServiceListOptions`、`ServiceInspectOptions` 和 `SwarmUnlockKeyResponse`，它们已移至 `api/types/swarm`。[moby/moby#50027](https://github.com/moby/moby/pull/50027)
- Go-SDK：api/types：弃用 `SecretCreateResponse`、`SecretListOptions`、`ConfigCreateResponse`、`ConfigListOptions`，它们已移至 `api/types/swarm`。[moby/moby#50024](https://github.com/moby/moby/pull/50024)
- Go-SDK：client：弃用 `IsErrNotFound`。[moby/moby#50012](https://github.com/moby/moby/pull/50012)
- Go-SDK：container：弃用 `IsValidHealthString`，建议使用 `api/types/container.ValidateHealthStatus`。[moby/moby#49893](https://github.com/moby/moby/pull/49893)
- Go-SDK：container：弃用 `StateStatus`、`WaitCondition` 以及相关的 `WaitConditionNotRunning`、`WaitConditionNextExit` 和 `WaitConditionRemoved` 常量，建议使用 `api/types/container` 中的等效项。[moby/moby#49874](https://github.com/moby/moby/pull/49874)
- Go-SDK：opts：弃用 `ListOpts.GetAll`，建议使用 `ListOpts.GetSlice`。[docker/cli#6032](https://github.com/docker/cli/pull/6032)
- 从 `docker search` 中移除已弃用的 `IsAutomated` 格式化占位符。[docker/cli#6091](https://github.com/docker/cli/pull/6091)
- 移除从非 OCI 合规的 `docker.pkg.github.com` 注册表拉取镜像的回退机制。[moby/moby#50094](https://github.com/moby/moby/pull/50094)
- 移除对拉取旧版 v2 schema 1 镜像的支持，并移除 `DOCKER_ENABLE_DEPRECATED_PULL_SCHEMA_1_IMAGE` 环境变量。[moby/moby#50036](https://github.com/moby/moby/pull/50036), [moby/moby#42300](https://github.com/moby/moby/pull/42300)
- `GET /info` 响应中的 `BridgeNfIptables` 和 `BridgeNfIp6tables` 字段在 API v1.48 中已弃用，现在在 API v1.50 中被省略。[moby/moby#49904](https://github.com/moby/moby/pull/49904)
- errdefs：弃用 `errdefs.FromStatusCode`。使用 containerd 的 `errhttp.ToNative` 替代。[moby/moby#50030](https://github.com/moby/moby/pull/50030)

## 28.1.1

{{< release-date date="2025-04-18" >}}

有关此版本中拉取请求 (PR) 和变更的完整列表，请参考相关的 GitHub 里程碑：

- [docker/cli, 28.1.1 里程碑](https://github.com/docker/cli/issues?q=is%3Aclosed+milestone%3A28.1.1)
- [moby/moby, 28.1.1 里程碑](https://github.com/moby/moby/issues?q=is%3Aclosed+milestone%3A28.1.1)

### 错误修复与改进

- 修复 `dockerd-rootless-setuptool.sh` 错误报告缺少 `iptables` 的问题。[moby/moby#49833](https://github.com/moby/moby/pull/49833)
- containerd 镜像存储：修复在使用包含零大小 tar 头的归档进行 `docker load` 时，可能导致守护进程崩溃的问题。[moby/moby#49837](https://github.com/moby/moby/pull/49837)

### 打包更新

- 将 Buildx 更新至 [v0.23.0](https://github.com/docker/buildx/releases/tag/v0.23.0)。[docker/docker-ce-packaging#1185](https://github.com/docker/docker-ce-packaging/pull/1185)
- 将 Compose 更新至 [v2.35.1](https://github.com/docker/compose/releases/tag/v2.35.1)。[docker/docker-ce-packaging#1188](https://github.com/docker/docker-ce-packaging/pull/1188)

### 联网

- 当未找到上游 DNS 服务器时，向容器的 `/etc/resolv.conf` 添加警告。[moby/moby#49827](https://github.com/moby/moby/pull/49827)

## 28.1.0

{{< release-date date="2025-04-17" >}}

有关此版本中拉取请求 (PR) 和变更的完整列表，请参考相关的 GitHub 里程碑：

- [docker/cli, 28.1.0 里程碑](https://github.com/docker/cli/issues?q=is%3Aclosed+milestone%3A28.1.0)
- [moby/moby, 28.1.0 里程碑](https://github.com/moby/moby/issues?q=is%3Aclosed+milestone%3A28.1.0)

### 新增功能

- 添加 `docker bake` 子命令，作为 `docker buildx bake` 的别名。[docker/cli#5947](https://github.com/docker/cli/pull/5947)
- 实验性：在 `docker run` 和 `docker create` 上添加一个新的 `--use-api-socket` 标志，以支持从容器内部访问 Docker 套接字，并支持将主机的凭据共享给容器。[docker/cli#5858](https://github.com/docker/cli/pull/5858)
- `docker image inspect` 现在支持 `--platform` 标志，用于检查多平台镜像的特定平台。[docker/cli#5934](https://github.com/docker/cli/pull/5934)

### 错误修复与改进

- 为上下文名称添加 CLI shell 补全。[docker/cli#6016](https://github.com/docker/cli/pull/6016)
- 修复 `docker images --tree` 未将非容器镜像内容大小计入总镜像内容大小的问题。[docker/cli#6000](https://github.com/docker/cli/pull/6000)
- 修复 `docker load` 不保留被替换镜像的问题。[moby/moby#49650](https://github.com/moby/moby/pull/49650)
- 修复登录到自定义注册表时的 `docker login` 提示。[docker/cli#6015](https://github.com/docker/cli/pull/6015)
- 修复 `docker stats` 在 CPU 核心数较多的机器上无法正常工作的问题。[moby/moby#49734](https://github.com/moby/moby/pull/49734)
- 修复导致 `docker pull/push` 在与私有仓库交互时失败的回归问题。[docker/cli#5964](https://github.com/docker/cli/pull/5964)
- 修复在没有 `ip_tables` 内核模块的主机上无法设置无根 Docker 的问题。[moby/moby#49727](https://github.com/moby/moby/pull/49727)
- 修复一个问题，该问题可能导致在 firewalld 重新加载后，不需要的 iptables 规则被还原且永远不会被删除。[moby/moby#49728](https://github.com/moby/moby/pull/49728)
- 改进 `docker service scale` 的 CLI 补全。[docker/cli#5968](https://github.com/docker/cli/pull/5968)
- `docker images --tree` 现在默认隐藏未打标签的镜像和悬空镜像。[docker/cli#5924](https://github.com/docker/cli/pull/5924)
- 如果无法建立与 Docker 守护进程的连接，`docker system info` 将提供一个退出代码。[docker/cli#5918](https://github.com/docker/cli/pull/5918)
- containerd 镜像存储：修复使用 BuildKit 构建时未触发 `image tag` 事件的问题。[moby/moby#49678](https://github.com/moby/moby/pull/49678)
- containerd 镜像存储：改进 `docker push/pull` 对远程注册表错误的处理。[moby/moby#49770](https://github.com/moby/moby/pull/49770)
- containerd 镜像存储：显示非层镜像 blob 的拉取进度。[moby/moby#49746](https://github.com/moby/moby/pull/49746)

### 打包更新

- 添加 Debian "Trixie" 软件包。[docker/docker-ce-packaging#1181](https://github.com/docker/docker-ce-packaging/pull/1181)
- 添加 Fedora 42 软件包。[docker/containerd-packaging#418](https://github.com/docker/containerd-packaging/pull/418), [docker/docker-ce-packaging#1169](https://github.com/docker/docker-ce-packaging/pull/1169)
- 添加 Ubuntu 25.04 "Plucky Puffin" 软件包。[docker/containerd-packaging#419](https://github.com/docker/containerd-packaging/pull/419), [docker/docker-ce-packaging#1177](https://github.com/docker/docker-ce-packaging/pull/1177)
- 将 BuildKit 更新至 [v0.21.0](https://github.com/moby/buildkit/releases/tag/v0.21.0)。[moby/moby#49809](https://github.com/moby/buildkit/pull/49809)
- 将 Compose 更新至 [v2.35.0](https://github.com/docker/compose/releases/tag/v2.35.0)。[docker/docker-ce-packaging#1183](https://github.com/docker/docker-ce-packaging/pull/1183)
- 将 Go 运行时更新至 [1.23.8](https://go.dev/doc/devel/release#go1.23.8)。[docker/cli#5986](https://github.com/docker/cli/pull/5986), [docker/docker-ce-packaging#1180](https://github.com/docker/docker-ce-packaging/pull/1180), [moby/moby#49737](https://github.com/moby/moby/pull/49737)

### 联网

- 修复导致 Swarm 容器上的主机端口映射在 `docker ps` 和 `docker inspect` 中出现重复的 bug。[moby/moby#49724](https://github.com/moby/moby/pull/49724)
- 修复导致容器网络挂载失败并报错 "Bridge port not forwarding" 的问题。[moby/moby#49705](https://github.com/moby/moby/pull/49705)
- 修复默认桥接网络中从容器移除 `--link` 的问题。[moby/moby#49778](https://github.com/moby/moby/pull/49778)
- 改进网络端点关系的跟踪，以减少 "has active endpoints" 错误被错误返回的机会。[moby/moby#49736](https://github.com/moby/moby/pull/49736)
- 改进 "has active endpoints" 错误消息，包含仍连接到正被删除网络的端点名称。[moby/moby#49773](https://github.com/moby/moby/pull/49773)

### API

- 将 API 版本更新为 [v1.49](https://docs.docker.com/engine/api/v1.49/)。[moby/moby#49718](https://github.com/moby/moby/pull/49718)
- `GET /image/{name}/json` 现在支持 `platform` 参数，允许指定检查多平台镜像的哪个平台变体。[moby/moby#49586](https://github.com/moby/moby/pull/49586)
- `GET /info` 现在返回一个 `FirewallBackend`，包含有关守护进程防火墙配置的信息。[moby/moby#49761](https://github.com/moby/moby/pull/49761)

### Go SDK

- 将最低要求的 Go 版本更新为 go1.23。[docker/cli#5868](https://github.com/docker/cli/pull/5868)
- cli/command/context：从 JSON 输出中移除临时字段 `ContextType`。[docker/cli#5981](https://github.com/docker/cli/pull/5981)
- client：尽可能保持镜像引用为规范格式。[moby/moby#49609](https://github.com/moby/moby/pull/49609)

### 弃用

- API：在 `GET /info` 响应的 `RegistryConfig` 结构体中，已弃用的 `AllowNondistributableArtifactsCIDRs` 和 `AllowNondistributableArtifactsHostnames` 字段在 API v1.49 中被省略。[moby/moby#49749](https://github.com/moby/moby/pull/49749)
- API：弃用：`GET /info` 端点中的 `ContainerdCommit.Expected`、`RuncCommit.Expected` 和 `InitCommit.Expected` 字段在 API v1.48 中已弃用，现在在 API v1.49 中被省略。[moby/moby#48556](https://github.com/moby/moby/pull/48556)
- Go-SDK：cli/command/image：弃用 `RunPull`：此函数仅在内部使用，将在下一个版本中移除。[docker/cli#5975](https://github.com/docker/cli/pull/5975)
- Go-SDK：cli/config/configfile：弃用 `ConfigFile.Experimental` 字段。自 v20.10 版本起实验性 CLI 功能始终启用，此字段不再使用。请改用 `ConfigFile.Features` 获取可选功能。此字段将在未来版本中移除。[docker/cli#5977](https://github.com/docker/cli/pull/5977)
- Go-SDK：弃用 `pkg/archive`，它已被迁移到 `github.com/moby/go-archive`。[moby/moby#49743](https://github.com/moby/moby/pull/49743)
- Go-SDK：弃用 `pkg/atomicwriter`，它已被迁移到 `github.com/moby/sys/atomicwriter`。[moby/moby#49748](https://github.com/moby/moby/pull/49748)
- Go-SDK：opts：移除已弃用的 `PortOpt`、`ConfigOpt`、`SecretOpt` 别名。[docker/cli#5953](https://github.com/docker/cli/pull/5953)
- Go-SDK：registry：弃用 `APIEndpoint.Official` 字段。[moby/moby#49706](https://github.com/moby/moby/pull/49706)

## 28.0.4

{{< release-date date="2025-03-25" >}}

有关此版本中拉取请求 (PR) 和变更的完整列表，请参考相关的 GitHub 里程碑：

- [docker/cli, 28.0.4 里程碑](https://github.com/docker/cli/issues?q=is%3Aclosed+milestone%3A28.0.4)
- [moby/moby, 28.0.4 里程碑](https://github.com/moby/moby/issues?q=is%3Aclosed+milestone%3A28.0.4)

### 错误修复与改进

- 修复导致 `docker pull/push` 在与私有仓库交互时失败的回归问题。[docker/cli#5964](https://github.com/docker/cli/pull/5964)


## 28.0.3

{{< release-date date="2025-03-25" >}}

有关此版本中拉取请求 (PR) 和变更的完整列表，请参考相关的 GitHub 里程碑：

- [docker/cli, 28.0.3 里程碑](https://github.com/docker/cli/issues?q=is%3Aclosed+milestone%3A28.0.3)
- [moby/moby, 28.0.3 里程碑](https://github.com/moby/moby/issues?q=is%3Aclosed+milestone%3A28.0.3)

### 错误修复与改进

- 修复当容器在数据消耗完毕前退出时，`docker run` 过早截断 `STDOUT`/`STDERR` 的问题。[docker/cli#5957](https://github.com/docker/cli/pull/5957)

### 打包更新

- 将 BuildKit 更新至 [v0.20.2](https://github.com/moby/buildkit/releases/tag/v0.20.2)。[moby/moby#49698](https://github.com/moby/moby/pull/49698)
- 将 `runc` 更新至 [v1.2.6](https://github.com/opencontainers/runc/releases/tag/v1.2.6)。[moby/moby#49682](https://github.com/moby/moby/pull/49682)
- 将 containerd 更新至 [v1.7.26](https://github.com/containerd/containerd/releases/tag/v1.7.26)。[docker/containerd-packaging#409](https://github.com/docker/containerd-packaging/pull/409)

## 28.0.2

{{< release-date date="2025-03-19" >}}

有关此版本中拉取请求 (PR) 和变更的完整列表，请参考相关的 GitHub 里程碑：

- [docker/cli, 28.0.2 里程碑](https://github.com/docker/cli/issues?q=is%3Aclosed+milestone%3A28.0.2)
- [moby/moby, 28.0.2 里程碑](https://github.com/moby/moby/issues?q=is%3Aclosed+milestone%3A28.0.2)

### 错误修复与改进

- 修复 CLI 特有属性 (`docker.cli.*`) 被无意中传递给下游 OTel 服务的问题。[docker/cli#5842](https://github.com/docker/cli/pull/5842)
- 修复用户指定的 `OTEL_RESOURCE_ATTRIBUTES` 被 CLI 内部遥测属性覆盖的问题。CLI 现在可以正确合并用户指定的属性与内部属性，允许两者并存。[docker/cli#5842](https://github.com/docker/cli/pull/5842)
- 修复当存在 v28.0.0 之前创建的容器时，守护进程在 Windows 上启动失败的问题。[moby/moby#49626](https://github.com/moby/moby/pull/49626)
- 修复 `docker buildx prune` 带 `--min-free-space` 时可能出现的错误。[moby/moby#49623](https://github.com/moby/moby/pull/49623)
- 修复关闭容器时，守护进程日志中虚假的 `io: read/write on closed pipe` 错误。[moby/moby#49590](https://github.com/moby/moby/pull/49590)
- 修复如果 containerd 套接字不能立即使用，Docker 守护进程会过早失败的问题。[moby/moby#49603](https://github.com/moby/moby/pull/49603)
- 默认在容器的 `/proc` 和 `/sys` 中屏蔽 Linux 热中断信息。[moby/moby#49560](https://github.com/moby/moby/pull/49560)
- 更新 `contrib/check-config.sh` 以检查更多与 iptables 相关的内核模块。[moby/moby#49622](https://github.com/moby/moby/pull/49622)
- containerd 镜像存储：修复通过 `--user` 传递的用户 ID 处理中的整数溢出问题。[moby/moby#49652](https://github.com/moby/moby/pull/49652)
- containerd 镜像存储：修复守护进程日志中出现的虚假 `reference for unknown type: application/vnd.in-toto+json` 警告。[moby/moby#49652](https://github.com/moby/moby/pull/49652)
- containerd 镜像存储：提高运行大量容器时 `docker ps` 的性能。[moby/moby#49365](https://github.com/moby/moby/pull/49365)

### 打包更新

- 将 BuildKit 更新至 [v0.20.1](https://github.com/moby/buildkit/releases/tag/v0.20.1)。[moby/moby#49587](https://github.com/moby/moby/pull/49587)
- 将 Buildx 更新至 [v0.22.0](https://github.com/docker/buildx/releases/tag/v0.22.0)。[docker/docker-ce-packaging#1175](https://github.com/docker/docker-ce-packaging/pull/1175)
- 将 Compose 更新至 [v2.34.0](https://github.com/docker/compose/releases/tag/v2.34.0)。[docker/docker-ce-packaging#1172](https://github.com/docker/docker-ce-packaging/pull/1172)
- 将 Go 运行时更新至 [1.23.7](https://go.dev/doc/devel/release#go1.23.7)。[docker/cli#5890](https://github.com/docker/cli/pull/5890), [docker/docker-ce-packaging#1171](https://github.com/docker/docker-ce-packaging/pull/1171), [moby/moby#49580](https://github.com/moby/moby/pull/49580)
- 将 RootlessKit 更新至 [v2.3.4](https://github.com/rootless-containers/rootlesskit/releases/tag/v2.3.4)。[moby/moby#49614](https://github.com/moby/moby/pull/49614)
- 将 containerd (仅限静态二进制文件) 更新至 [v1.7.27](https://www.github.com/containerd/containerd/releases/tag/v1.7.27)。[moby/moby#49656](https://github.com/moby/moby/pull/49656)

### 联网

- 添加环境变量 `DOCKER_INSECURE_NO_IPTABLES_RAW=1`，以允许 Docker 在 Linux 内核无法提供 `CONFIG_IP_NF_RAW` 支持的系统上运行。启用后，Docker 将不会在 iptables `raw` 表中创建规则。警告：不建议在生产环境中使用此设置，因为它会降低安全性，允许本地网络上的其他主机路由到发布在主机地址上的端口，即使它们发布到 `127.0.0.1`。此选项会绕过 Docker Engine 28.0.0 中引入的一些安全加固。[moby/moby#49621](https://github.com/moby/moby/pull/49621)
- 允许在父接口处于 down 状态的情况下，启动连接到 macvlan 网络驱动程序端点的容器。[moby/moby#49630](https://github.com/moby/moby/pull/49630)
- 不再对源自 `gateway_mode=routed` 网络的数据包跳过 DNAT。[moby/moby#49577](https://github.com/moby/moby/pull/49577)
- 修复导致 `docker ps` 不一致地报告双栈端口映射的 bug。[moby/moby#49657](https://github.com/moby/moby/pull/49657)
- 修复导致 `docker-proxy` 停止向容器转发 UDP 数据报的 bug。[moby/moby#49649](https://github.com/moby/moby/pull/49649)
- 修复导致 `docker-proxy` 过早关闭与容器的 UDP 连接并导致源地址不必要地发生变化的 bug。[moby/moby#49649](https://github.com/moby/moby/pull/49649)

### Go SDK

- 将各种类型和常量从 `cli-plugins/manager` 移至独立包。[docker/cli#5902](https://github.com/docker/cli/pull/5902)
- 将最低要求的 Go 版本更新为 go1.23。[moby/moby#49541](https://github.com/moby/moby/pull/49541)
- `cli/command`：将 `PrettyPrint` 工具移至 `cli/command/formatter`。[docker/cli#5916](https://github.com/docker/cli/pull/5916)
- runconfig/errors：将 `ErrConflictHostNetwork` 拆分为 `ErrConflictConnectToHostNetwork` 和 `ErrConflictDisconnectFromHostNetwork`。[moby/moby#49605](https://github.com/moby/moby/pull/49605)

### 弃用

- Go-SDK：弃用 `cli-plugins/manager.ResourceAttributesEnvvar` 常量。它曾用于内部，但由于它持有 OpenTelemetry 规范的一部分 `OTEL_RESOURCE_ATTRIBUTES` 名称，因此用户应定义自己的常量。它将在下一个版本中移除。[docker/cli#5881](https://github.com/docker/cli/pull/5881)
- Go-SDK：弃用 `opts.PortOpt`、`opts.ConfigOpt` 和 `opts.SecretOpt`。这些类型已移至 `opts/swarmopts` 包。[docker/cli#5907](https://github.com/docker/cli/pull/5907)
- Go-SDK：移除 `service/logs` 包。[docker/cli#5910](https://github.com/docker/cli/pull/5910)
- Go-SDK：`cli/command/image`：弃用 `PushTrustedReference` 并移至 `cli/trust`。[docker/cli#5894](https://github.com/docker/cli/pull/5894)
- Go-SDK：`cli/command/image`：弃用并内化 `TrustedPush`。[docker/cli#5894](https://github.com/docker/cli/pull/5894)
- Go-SDK：`cli/command`：弃用 `Cli.NotaryClient`：改用 [`trust.GetNotaryRepository`](https://pkg.go.dev/github.com/docker/cli@v28.0.1+incompatible/cli/trust#GetNotaryRepository)。此方法不再使用，将在下一个版本中移除。[docker/cli#5885](https://github.com/docker/cli/pull/5885)
- Go-SDK：`cli/command`：弃用 `Cli.RegistryClient`。此方法仅在内部使用，将在下一个版本中移除。请改用 [`client.NewRegistryClient`](https://pkg.go.dev/github.com/docker/cli@v28.0.1+incompatible/cli/registry/client#NewRegistryClient)。[docker/cli#5889](https://github.com/docker/cli/pull/5889)
- Go-SDK：`registry`：弃用 `RepositoryInfo.Official` 字段。[moby/moby#49567](https://github.com/moby/moby/pull/49567)
- Go-SDK：`registry`：弃用 `HostCertsDir`：此函数仅在内部使用，将在下一个版本中移除。[moby/moby#49612](https://github.com/moby/moby/pull/49612)
- Go-SDK：`registry`：弃用 `SetCertsDir`：在使用 RootlessKit 运行时会自动选择证书目录，不应再手动设置。[moby/moby#49612](https://github.com/moby/moby/pull/49612)

## 28.0.1

{{< release-date date="2025-02-26" >}}

有关此版本中拉取请求 (PR) 和变更的完整列表，请参考相关的 GitHub 里程碑：

- [docker/cli, 28.0.1 里程碑](https://github.com/docker/cli/issues?q=is%3Aclosed+milestone%3A28.0.1)
- [moby/moby, 28.0.1 里程碑](https://github.com/moby/moby/issues?q=is%3Aclosed+milestone%3A28.0.1)

### 联网

- 移除了对内核模块 `ip_set`、`ip_set_hash_net` 和 `netfilter_xt_set` 的依赖。
  * 这种依赖是在 28.0.0 版本引入的，但被证明太具有破坏性。使用这些模块的 iptables 规则已被替换。[moby/moby#49530](https://github.com/moby/moby/pull/49530)
- 允许在禁用 IPv6 的主机上启动守护进程，而无需 `--ip6tables=false`。[moby/moby#49525](https://github.com/moby/moby/pull/49525)
- 修复了导致带有 `--restart=always` 且已发布端口已被占用的容器陷入重启死循环的 bug。[moby/moby#49507](https://github.com/moby/moby/pull/49507)
- 修复了由于 iptables 规则顺序不正确导致的 Swarm ingress 问题。[moby/moby#49538](https://github.com/moby/moby/pull/49538)
- 修复了从 `--config-only` 网络创建 swarm 范围网络的问题。[moby/moby#49521](https://github.com/moby/moby/pull/49521)
- 修复了 `docker network inspect` 对于没有特定 IPAM 配置的新创建网络，在守护进程重启前会报告带有 CIDR 后缀的 IPv6 网关的问题。[moby/moby#49520](https://github.com/moby/moby/pull/49520)
- 改进了当内核模块 `ip_set`、`ip_set_hash_net` 和 `netilter_xt_set` 不可用时报告的错误。[moby/moby#49524](https://github.com/moby/moby/pull/49524)
- 将大部分 Docker 的 iptables 规则移出了 filter-FORWARD 链，以便其他应用程序可以自由追加必须遵循 Docker 规则的规则。[moby/moby#49518](https://github.com/moby/moby/pull/49518)
- 更新了 `--help` 输出和手册页，说明哪些选项仅适用于默认桥接网络。[moby/moby#49522](https://github.com/moby/moby/pull/49522)


### 错误修复与改进

- 修复 `docker context create` 在使用 `"skip-tls-verify"` 选项时总是返回错误的问题。[docker/cli#5850](https://github.com/docker/cli/pull/5850)
- 修复 shell 补全对服务和节点建议使用 ID 而不是名称的问题。[docker/cli#5848](https://github.com/docker/cli/pull/5848)
- 修复当 `docker exec/run` 返回非零状态时，无意中将退出状态打印到标准错误输出的问题。[docker/cli#5854](https://github.com/docker/cli/pull/5854)
- 修复回归问题 `protocol "tcp" is not supported by the RootlessKit port driver "slirp4netns"`。[moby/moby#49514](https://github.com/moby/moby/pull/49514)
- containerd 镜像存储：修复 `docker inspect` 无法显示所有平台都缺少层的多平台镜像的问题。[moby/moby#49533](https://github.com/moby/moby/pull/49533)
- containerd 镜像存储：修复 `docker images --tree` 报告错误内容大小的问题。[moby/moby#49535](https://github.com/moby/moby/pull/49535)
- 修复 i386 平台上的编译问题 [moby/moby#49526](https://github.com/moby/moby/pull/49526)

### 打包更新

- 将 `github.com/go-jose/go-jose/v4` 更新至 v4.0.5 以解决 [GHSA-c6gw-w398-hv78](https://github.com/go-jose/go-jose/security/advisories/GHSA-c6gw-w398-hv78) / [CVE-2025-27144](https://www.cve.org/CVERecord?id=CVE-2025-27144)。[docker/cli#5867](https://github.com/docker/cli/pull/5867)
- 将 Buildx 更新至 [v0.21.1](https://github.com/docker/buildx/releases/tag/v0.21.1)。[docker/docker-ce-packaging#1167](https://github.com/docker/docker-ce-packaging/pull/1167)
- 将 Compose 更新至 [v2.33.1](https://github.com/docker/compose/releases/tag/v2.33.1)。[docker/docker-ce-packaging#1168](https://github.com/docker/docker-ce-packaging/pull/1168)

### API

- containerd 镜像存储：修复 `GET /images/json?manifests=1` 不为仅含 index 的镜像填充 `Manifests` 的问题 [moby/moby#49533](https://github.com/moby/moby/pull/49533)
- containerd 镜像存储：修复 `GET /images/json and /images/<name>/json` 的 `Size.Content` 字段包含了本地不可用内容大小的问题 [moby/moby#49535](https://github.com/moby/moby/pull/49535)


## 28.0.0

{{< release-date date="2025-02-19" >}}

有关此版本中拉取请求 (PR) 和变更的完整列表，请参考相关的 GitHub 里程碑：

- [docker/cli, 28.0.0 里程碑](https://github.com/docker/cli/issues?q=is%3Aclosed+milestone%3A28.0.0)
- [moby/moby, 28.0.0 里程碑](https://github.com/moby/moby/issues?q=is%3Aclosed+milestone%3A28.0.0)
- 已弃用和已移除的功能，请参阅 [已弃用的功能](https://github.com/docker/cli/blob/v28.0.0/docs/deprecated.md)。
- Engine API 的变更，请参阅 [API 版本历史](https://github.com/moby/moby/blob/v28.0.0/docs/api/version-history.md)。

### 新增功能

- 增加了通过 `--mount type=image` 在容器内部挂载镜像的能力。[moby/moby#48798](https://github.com/moby/moby/pull/48798)
  * 您还可以指定 `--mount type=image,image-subpath=[subpath],...` 选项来挂载镜像中的特定路径。[docker/cli#5755](https://github.com/docker/cli/pull/5755)
- `docker images --tree` 现在会显示元数据徽章 [docker/cli#5744](https://github.com/docker/cli/pull/5744)
- `docker load`、`docker save` 和 `docker history` 现在支持 `--platform` 标志，允许您在多平台镜像上选择特定平台进行单平台操作。[docker/cli#5331](https://github.com/docker/cli/pull/5331)
- 在 `docker service create` 和 `docker stack` 中添加了 `OOMScoreAdj` 支持。[docker/cli#5145](https://github.com/docker/cli/pull/5145)
- `docker buildx prune` 现在支持 `reserved-space`、`max-used-space`、`min-free-space` 和 `keep-bytes` 过滤器。[moby/moby#48720](https://github.com/moby/moby/pull/48720)
- Windows：支持将 containerd 作为守护进程的子进程运行，而不是使用系统安装的 containerd。[moby/moby#47955](https://github.com/moby/moby/pull/47955)


### 联网

- `docker-proxy` 二进制文件已更新，旧版本将无法与更新后的 `dockerd` 配合工作。[moby/moby#48132](https://github.com/moby/moby/pull/48132)
    - 修复了在设置 `iptables` NAT 规则之后，用户空间代理 (`docker-proxy`) 可能接受 TCP 连接但随后失败的问题窗口。
    - 可执行文件 `rootlesskit-docker-proxy` 不再使用，已从构建和发行版中移除。
- 从主机的 `/etc/resolv.conf` 读取的 DNS 域名服务器现在始终从主机的网络命名空间访问。[moby/moby#48290](https://github.com/moby/moby/pull/48290)
    - 当主机的 `/etc/resolv.conf` 中没有域名服务器且没有 `--dns` 覆盖时，除了默认桥接网络和构建容器外，不再使用 Google 的 DNS 服务器。
- 桥接网络和 macvlan 网络中的容器接口现在使用随机生成的 MAC 地址。[moby/moby#48808](https://github.com/moby/moby/pull/48808)
    - 在接口启动时将发送无偿 ARP / 邻居通告 (Gratuitous ARP / Neighbour Advertisement) 消息，以便在 IP 地址重用时，它们与新生成的 MAC 地址相关联。
    - 默认桥接网络中的 IPv6 地址现在由 IPAM 分配，而不是从 MAC 地址派生。
- 已弃用的 OCI `prestart` 钩子现在仅由构建容器使用。对于其他容器，网络接口在任务创建完成后、容器任务启动前被添加到网络命名空间中。[moby/moby#47406](https://github.com/moby/moby/pull/47406)
- 为 `docker run`、`docker container create` 和 `docker network connect` 添加了新的 `gw-priority` 选项。Engine 将使用此选项来确定哪个网络为容器提供默认网关。在 `docker run` 中，此选项仅可通过扩展的 `--network` 语法使用。[docker/cli#5664](https://github.com/docker/cli/pull/5664)
- 添加了新的网络标签 `com.docker.network.endpoint.ifname`，用于自定义将容器连接到网络时使用的接口名称。Linux 上的所有内置网络驱动程序都支持该标签。[moby/moby#49155](https://github.com/moby/moby/pull/49155)
  - 当使用多个网络创建容器时，无法保证网络连接容器的顺序。因此，如果自定义接口名称使用了与自动生成名称相同的前缀 (例如 `eth`)，容器可能会启动失败。
  - 建议的做法是使用不同的前缀 (例如 `en0`)，或者使用足够大的数字后缀以确保永不冲突 (例如 `eth100`)。
  - 此标签可以在 `docker network connect` 通过 `--driver-opt` 标志指定，例如 `docker network connect --driver-opt=com.docker.network.endpoint.ifname=foobar …`。
  - 或者通过 `docker run` 的长格式 `--network` 标志指定，例如 `docker run --network=name=bridge,driver-opt=com.docker.network.endpoint.ifname=foobar …`
- 如果自定义网络驱动程序报告了 `GwAllocChecker` 能力，那么在创建网络之前，它将收到一个带有网络选项的 `GwAllocCheckerRequest`。自定义驱动程序随后可以回复不应分配网关 IP 地址。[moby/moby#49372](https://github.com/moby/moby/pull/49372)

#### 桥接网络中的端口发布

- `dockerd` 现在要求 Linux 内核支持 `ipset`。[moby/moby#48596](https://github.com/moby/moby/pull/48596)
  - 用于实现端口发布和网络隔离的 `iptables` 和 `ip6tables` 规则已进行了广泛修改。这实现了一些功能性变更，并且是重构以在未来版本中启用原生 `nftables` 支持的第一步。[moby/moby#48815](https://github.com/moby/moby/issues/48815)
  - 如果需要降级到早期版本的守护进程，则需要对新规则进行一些手动清理。最简单且最可靠的方法是重启主机，或者在启动旧版本守护进程之前使用 `iptables -F` 和 `ip6tables -F` 从 `filter` 表中刷新所有现有的 `iptables` 规则。如果无法做到这一点，请以 root 身份运行以下命令：
    - `iptables -D FORWARD -m set --match-set docker-ext-bridges-v4 dst -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT; ip6tables -D FORWARD -m set --match-set docker-ext-bridges-v6 dst -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT`
    - `iptables -D FORWARD -m set --match-set docker-ext-bridges-v4 dst -j DOCKER; ip6tables -D FORWARD -m set --match-set docker-ext-bridges-v6 dst -j DOCKER`
    - 如果您之前运行时的 iptables filter-FORWARD 策略设置为 `ACCEPT` 且需要恢复对未发布端口的访问，还请从 `DOCKER` 链中删除针对每个桥接网络的规则。例如，`iptables -D DOCKER ! -i docker0 -o docker0 -j DROP`。
- 修复了一个安全问题，该问题曾允许远程主机在容器的已发布端口上直接连接到容器。[moby/moby#49325](https://github.com/moby/moby/pull/49325)
- 修复了一个安全问题，该问题曾允许邻居主机连接到映射在回环地址上的端口。[moby/moby#49325](https://github.com/moby/moby/pull/49325)
- 修复了一个阻止向链路本地地址发布端口的问题。[moby/moby#48570](https://github.com/moby/moby/pull/48570)
- 容器发布的 UDP 端口现在可以通过主机的公共 IP 地址被其他网络上的容器可靠访问。[moby/moby#48571](https://github.com/moby/moby/pull/48571)
- 只有当 Docker 在主机本身启用 IPv6 转发 (sysctls `net.ipv6.conf.all.forwarding` 和 `net.ipv6.conf.default.forwarding`) 时，Docker 现在才会将 `filter` 表中 `FORWARD` 链的 `ip6tables` 策略设置为 `DROP`。这现在与现有的 IPv4 行为保持一致。[moby/moby#48594](https://github.com/moby/moby/pull/48594)
    - 如果您的主机启用了 IPv6 转发，但您之前依赖 Docker 将 ip6tables filter-FORWARD 策略设置为 `DROP`，您可能需要更新主机的配置以确保其安全。
- 在 `DOCKER` iptables 链中，现在会拦截从未通过 `p`/`-publish` 暴露的容器端口进行的直接路由访问。[moby/moby#48724](https://github.com/moby/moby/pull/48724)
    - 如果您的主机之前将默认的 iptables filter-FORWARD 策略保留为 `ACCEPT`，且仍需要从远程主机对容器的未发布端口进行直接路由访问，选项有：
      - 发布您需要的端口。
      - 使用下文描述的新 `gateway_mode_ipv[46]=nat-unprotected`。
    - 发布到主机地址的容器端口将继续可以通过这些主机地址访问 (使用 NAT 或用户空间代理)。
    - 未发布的容器端口继续可以通过容器的 IP 地址从 Docker 主机直接访问。
- 使用 `gateway_mode_ipv[46]=routed` 创建的网络现在可以从同一 Docker 主机上运行的其他桥接网络以及从主机外部访问。[moby/moby#48596](https://github.com/moby/moby/pull/48596)
- 桥接驱动程序选项 `com.docker.network.bridge.gateway_mode_ipv4` 和 `com.docker.network.bridge.gateway_mode_ipv6` 现在接受 `nat-unprotected` 模式。[moby/moby#48597](https://github.com/moby/moby/pull/48597)
    - `nat-unprotected` 与默认的 `nat` 模式类似，但不设置按端口/协议的规则。这意味着任何容器端口都可以通过远程主机的直接路由访问。
- 桥接驱动程序选项 `com.docker.network.bridge.gateway_mode_ipv4` 和 `com.docker.network.bridge.gateway_mode_ipv6` 现在当网络也是 `internal` 时接受 `isolated` 模式。[moby/moby#49262](https://github.com/moby/moby/pull/49262)
  - 在 `internal` 网络中，通常会为桥接设备分配一个地址。因此，Docker 主机上的进程可以访问该网络，且该网络中的容器可以访问在该桥接地址上监听的主机服务 (包括在“任何”主机地址 `0.0.0.0` 或 `::` 上监听的服务)。
  - 使用网关模式 `isolated` 创建的 `internal` 桥接网络在 Docker 主机上没有地址。
- 当端口映射包含由于使用 `--gateway_mode_ipv[46]` 禁用了来自主机的 NAT 而无法使用的主机 IP 地址或端口号时，容器创建将不再失败。这些未使用的字段可能在连接或断开网络导致网关端点发生变化时需要。系统将记录一条关于未使用字段的消息。[moby/moby#48575](https://github.com/moby/moby/pull/48575)
- 在启用用户空间代理时，不再为容器自己的发布端口创建 iptables nat-POSTROUTING 伪装规则。[moby/moby#48854](https://github.com/moby/moby/pull/48854)

#### IPv6

- 为 `docker network create` 添加了 `--ipv4` 选项。要禁用网络的 IPv4 地址分配，请使用 `docker network create --ipv4=false [...]`。[docker/cli#5599](https://github.com/docker/cli/pull/5599)
- 守护进程选项 `--ipv6` (在 `daemon.json` 中为 `"ipv6": true`) 现在可以不带 `fixed-cidr-v6` 使用。[moby/moby#48319](https://github.com/moby/moby/pull/48319)
- IPAM 现在可以处理大于 "/64" 的子网。[moby/moby#49223](https://github.com/moby/moby/pull/49223)
- 现在对属于桥接网络的网桥分配的地址禁用了重复地址检测 (DAD)。[moby/moby#48609](https://github.com/moby/moby/pull/48609)
- 对 `host-gateway` 进行了修改，以兼容仅 IPv6 网络。[moby/moby#48807](https://github.com/moby/moby/pull/48807)
  - 当在 `--add-host` 选项中使用特殊值 `host-gateway` 代替地址时，它会被替换为 Docker 主机上的地址，以便能够按名称引用主机。所使用的地址属于默认桥接网络 (通常是 `docker0`)。到目前为止，它一直是一个 IPv4 地址，因为桥接网络上的所有容器都有 IPv4 地址。
  - 现在，如果默认桥接网络启用了 IPv6，则会为 IPv4 和 IPv6 地址创建 `/etc/hosts` 条目。因此，仅连接到仅 IPv6 网络的容器可以按名称访问主机。
  - `--host-gateway-ip` 选项覆盖用于替换 `host-gateway` 的地址。现在命令行允许使用两个此类选项，分别针对一个 IPv4 网关和一个 IPv6 网关。
  - 在 `daemon.json` 文件中，要提供两个地址，请使用 `"host-gateway-ips"`。例如，`"host-gateway-ips": ["192.0.2.1", "2001:db8::1111"]`。


### 错误修复与改进

- 默认将 IPv6 回环地址添加为不安全注册表。[moby/moby#48540](https://github.com/moby/moby/pull/48540)
- 为 `dockerd` 添加了对 Cobra 生成的补全脚本的支持。[moby/moby#49339](https://github.com/moby/moby/pull/49339)
- 修复了当容器通过开机自动启动的 `systemd` 启动时 DNS 查询失败的问题 [moby/moby#48812](https://github.com/moby/moby/pull/48812)
- 修复了 Docker Swarm 模式忽略 `volume.subpath` 的问题 [docker/cli#5833](https://github.com/docker/cli/pull/5833)
- 修复了 `docker export` 在操作取消后仍继续导出的问题。[moby/moby#49265](https://github.com/moby/moby/pull/49265)
- 修复了 `docker export` 在失败后不释放容器可写层的问题。[moby/moby#48517](https://github.com/moby/moby/pull/48517)
- 修复了 `docker images --tree` 在有多个名称可用时，不必要地截断长镜像名称的问题 [docker/cli#5757](https://github.com/docker/cli/pull/5757)
- 修复了一个 bug，即名称与另一个容器 ID 匹配的容器在守护进程启动时未被还原。[moby/moby#48669](https://github.com/moby/moby/pull/48669)
- 修复了导致 `docker ps` 显示的部分 IPv6 地址未被正确加上方括号的问题 [docker/cli#5468](https://github.com/docker/cli/pull/5468)
- 修复了阻止在 `docker run` 期间取消镜像拉取操作的 bug。[docker/cli#5645](https://github.com/docker/cli/pull/5645)
- 修复了守护进程作为 Windows 服务运行时的错误处理，以防止不正常的退出。[moby/moby#48518](https://github.com/moby/moby/pull/48518)
- 修复了导致 `docker run` 输出在使用 `--attach stdout` 或 `--attach stderr` 与 `stdin` 相比时不一致的问题。`docker run --attach stdin` 现在会在容器退出时退出。[docker/cli#5662](https://github.com/docker/cli/pull/5662)
- 修复了由 NSS 模块支持 subid 的无根 Docker 设置。[moby/moby#49036](https://github.com/moby/moby/pull/49036)
- CLI 生成的补全脚本现在在每个命令/标志建议旁边显示描述。[docker/cli#5756](https://github.com/docker/cli/pull/5756)
- `docker ps` 在端口绑定中显示的 IPv6 地址现在带有方括号 [docker/cli#5363](https://github.com/docker/cli/pull/5363)
- 为 Compose 实现了端口验证方法 [docker/cli#5524](https://github.com/docker/cli/pull/5524)
- 改进了命令行无效标志的错误输出。[docker/cli#5233](https://github.com/docker/cli/pull/5233)
- 改进了尝试使用另一个容器网络命名空间启动容器失败时的错误提示。[moby/moby#49367](https://github.com/moby/moby/pull/49367)
- 改进了对无效 API 错误的处理，这曾可能导致显示空错误消息。[moby/moby#49373](https://github.com/moby/moby/pull/49373)
- 改进了对于未知 (子) 命令和无效参数的输出及一致性 [docker/cli#5234](https://github.com/docker/cli/pull/5234)
- 改进了守护进程配置中 `exec-opts` 的验证。[moby/moby#48979](https://github.com/moby/moby/pull/48979)
- 更新了对 `--gpus=0` 标志的处理，使其与 NVIDIA Container Runtime 保持一致。[moby/moby#48482](https://github.com/moby/moby/pull/48482)
- `client.ContainerCreate` 现在会将 `HostConfig` 中的 `CapAdd` 和 `CapDrop` 字段标准化为它们的规范形式。[moby/moby#48551](https://github.com/moby/moby/pull/48551)
- `docker image save` 现在产生稳定的时间戳。[moby/moby#48611](https://github.com/moby/moby/pull/48611)
- `docker inspect` 现在允许您检查 Swarm 配置 [docker/cli#5573](https://github.com/docker/cli/pull/5573)
- containerd 镜像存储：在 `docker pull` 中增加了对 `Extracting` 层状态的支持。[moby/moby#49064](https://github.com/moby/moby/pull/49064)
- containerd 镜像存储：修复了 `commit`、`import` 和 `build` 未将被替换的镜像保留为悬空镜像的问题。[moby/moby#48316](https://github.com/moby/moby/pull/48316)
- containerd 镜像存储：使 `docker load --platform` 在请求的平台未加载时返回错误。[moby/moby#48718](https://github.com/moby/moby/pull/48718)
- 修复了对 `--link` 选项的验证。[docker/cli#5739](https://github.com/docker/cli/pull/5739)
- 添加了对 `network-diagnostic-port` 守护进程配置选项的验证。[moby/moby#49305](https://github.com/moby/moby/pull/49305)
- 除非另有明确配置，否则在不需要 IP 地址作为网关的情况下，将不再保留 IP 地址。即：使用了 `com.docker.network.bridge.inhibit_ipv4` 选项的“内部”桥接网络、没有父接口的 `ipvlan` 或 `macvlan` 网络，以及 L3 IPvlan 模式。[moby/moby#49261](https://github.com/moby/moby/pull/49261)
- 如果自定义网络驱动程序报告了 `GwAllocChecker` 能力，那么在创建网络之前，它将收到一个带有网络选项的 `GwAllocCheckerRequest`。自定义驱动程序随后可以回复不应分配网关 IP 地址。[moby/moby#49372](https://github.com/moby/moby/pull/49372)
- 修复了一个问题，即容器无法同时附加到 L3 IPvlan 和其他网络类型。[moby/moby#49130](https://github.com/moby/moby/pull/49130)
- 断开容器与网络的连接时，现在会移除正确的 `/etc/hosts` 条目。[moby/moby#48857](https://github.com/moby/moby/pull/48857)
- 修复了重复的网络断开事件。[moby/moby#48800](https://github.com/moby/moby/pull/48800)
- 解决了与更改 `docker0` 的 `fixed-cidr` 相关的问题，以及从用户管理的默认桥接网络 (`--bridge`) 推断配置的问题。[moby/moby#48319](https://github.com/moby/moby/pull/48319)
- 移除了在 26.1.0 版本中引入的 `windows-dns-proxy` 功能标志，该标志用于控制从 Windows 容器向外部 DNS 解析器转发以使 `nslookup` 工作。该功能在 27.0.0 版本中默认启用。[moby/moby#48738](https://github.com/moby/moby/pull/48738)
- 移除了用于 SCTP 校验和的 `iptables` mangle 规则。该规则可以通过在守护进程环境中设置 `DOCKER_IPTABLES_SCTP_CHECKSUM=1` 来重新启用。此覆盖将在未来版本中移除。[moby/moby#48149](https://github.com/moby/moby/pull/48149)
- 在大多数情况下，连接到桥接网络的速度更快。[moby/moby#49302](https://github.com/moby/moby/pull/49302)


### 打包更新

- 将 Go 运行时更新至 [1.23.6](https://go.dev/doc/devel/release#go1.23.6)。[docker/cli#5795](https://github.com/docker/cli/pull/5795), [moby/moby#49393](https://github.com/moby/moby/pull/49393), [docker/docker-ce-packaging#1161](https://github.com/docker/docker-ce-packaging/pull/1161)
- 将 `runc` 更新至 [v1.2.5](https://github.com/opencontainers/runc/releases/tag/v1.2.5) (仅限静态二进制文件)。[moby/moby#49464](https://github.com/moby/moby/pull/49464)
- 将 containerd 更新至 [v1.7.25](https://github.com/containerd/containerd/releases/tag/v1.7.25)。[moby/moby#49252](https://github.com/moby/moby/pull/49252)
- 将 BuildKit 更新至 [v0.20.0](https://github.com/moby/buildkit/releases/tag/v0.20.0)。[moby/moby#49495](https://github.com/moby/moby/pull/49495)
- 将 Buildx 更新至 [v0.21.0](https://github.com/docker/buildx/releases/tag/v0.21.0)。[docker/docker-ce-packaging#1166](https://github.com/docker/docker-ce-packaging/pull/1166)
- 将 Compose 更新至 [v2.32.4](https://github.com/docker/compose/releases/tag/v2.32.3)。[docker/docker-ce-packaging#1143](https://github.com/docker/docker-ce-packaging/pull/1143)
- `dockerd(8)` 手册页的权威来源已迁回 `moby/moby` 仓库本身。[moby/moby#48298](https://github.com/moby/moby/pull/48298)

### Go SDK

- 改进了空对象 ID 的验证。客户端现在在尝试使用空 ID 或名称时返回 "Invalid Parameter" 错误。这将某些 "Inspect" 函数返回的错误从 "Not found" 更改为了 "Invalid Parameter"。[moby/moby#49381](https://github.com/moby/moby/pull/49381)
- `Client.ImageBuild()` 现在会从 API 请求的查询字符串中省略默认值。[moby/moby#48651](https://github.com/moby/moby/pull/48651)
- `api/types/container`：合并了 `Stats` 和 `StatsResponse` [moby/moby#49287](https://github.com/moby/moby/pull/49287)
- `client.WithVersion`：在设置 API 版本时去除 v 前缀 [moby/moby#49352](https://github.com/moby/moby/pull/49352)
- `client`：增加了 `WithTraceOptions`，允许指定自定义 OTe1 追踪选项。[moby/moby#49415](https://github.com/moby/moby/pull/49415)
- `client`：增加了 `HijackDialer` 接口。[moby/moby#49388](https://github.com/moby/moby/pull/49388)
- `client`：增加了 `SwarmManagementAPIClient` 接口，用于描述所有与 Swarm 特有对象相关的 API 客户端方法。[moby/moby#49388](https://github.com/moby/moby/pull/49388)
- `client`：增加了 `WithTraceOptions`，允许指定自定义 OTel 追踪选项。[moby/moby#49415](https://github.com/moby/moby/pull/49415)
- `client`：`ImageHistory`、`ImageLoad` 和 `ImageSave` 现在使用变长函数选项 [moby/moby#49466](https://github.com/moby/moby/pull/49466)
- `pkg/containerfs`：移至 internal [moby/moby#48097](https://github.com/moby/moby/pull/48097)
- `pkg/reexec`：现在可以在除 Linux、Windows、macOS 和 FreeBSD 以外的平台上使用 [moby/moby#49118](https://github.com/moby/moby/pull/49118)
- `api/types/container`：引入 `CommitResponse` 类型。目前是 `IDResponse` 的别名，但在未来版本中可能成为独立类型。[moby/moby#49444](https://github.com/moby/moby/pull/49444)
- `api/types/container`：引入 `ExecCreateResponse` 类型。目前是 `IDResponse` 的别名，但在未来版本中可能成为独立类型。[moby/moby#49444](https://github.com/moby/moby/pull/49444)

### API

- 将 API 版本更新为 [v1.48](https://docs.docker.com/engine/api/v1.48/) [moby/moby#48476](https://github.com/moby/moby/pull/48476)
- `GET /images/{name}/json` 响应现在返回 `Manifests` 字段，包含有关镜像索引中包含的子清单的信息。这包括平台特定的清单和构建证明等内容。[moby/moby#48264](https://github.com/moby/moby/pull/48264)
- `POST /containers/create` 现在支持 `image` 类型的 `Mount`，用于在容器内部挂载镜像。[moby/moby#48798](https://github.com/moby/moby/pull/48798)
- `GET /images/{name}/history` 现在支持 `platform` 参数 (JSON 编码的 OCI Platform 类型)，允许您指定要显示历史记录的平台。[moby/moby#48295](https://github.com/moby/moby/pull/48295)
- `POST /images/{name}/load` 和 `GET /images/{name}/get` 现在支持 `platform` 参数 (JSON 编码的 OCI Platform 类型)，允许您指定要加载/保存的平台。不传递此参数将导致加载/保存完整的多平台镜像。[moby/moby#48295](https://github.com/moby/moby/pull/48295)
- 改进了容器调整大小和 exec 调整大小时无效宽度/高度的错误提示 [moby/moby#48679](https://github.com/moby/moby/pull/48679)
- `POST /containers/create` 端点现在在将容器范围的 `VolumeDriver` 选项与通过 `Mounts` 定义的卷结合使用时，会在响应中包含一条警告，因为 `VolumeDriver` 选项对这些卷无效。此警告之前由 CLI 生成。[moby/moby#48789](https://github.com/moby/moby/pull/48789)
- containerd 镜像存储：`GET /images/json` 和 `GET /images/{name}/json` 响应现在包含 `Descriptor` 字段，其中包含镜像目标的 OCI 描述符。仅当守护进程提供多平台镜像存储时，才会填充新字段。[moby/moby#48894](https://github.com/moby/moby/pull/48894)
- containerd 镜像存储：`GET /containers/{name}/json` 现在返回一个 `ImageManifestDescriptor` 字段，其中包含用于创建容器的镜像的平台特定镜像清单的 OCI 描述符。[moby/moby#48855](https://github.com/moby/moby/pull/48855)
- 增加了调试端点 (`GET /debug/vars`、`GET /debug/pprof/`、`GET /debug/pprof/cmdline`、`GET /debug/pprof/profile`、`GET /debug/pprof/symbol`、`GET /debug/pprof/trace`、`GET /debug/pprof/{name}`)，现在也可以通过版本化 API 路径 (`/v<API-版本>/<端点>`) 访问。[moby/moby#49051](https://github.com/moby/moby/pull/49051)
- 修复了 API 对于验证错误返回 `500` 状态码而不是 `400` 的问题。[moby/moby#49217](https://github.com/moby/moby/pull/49217)
- 修复了归档端点 `HEAD /containers/{name:.*}/archive`、`GET /containers/{name:.*}/archive`、`PUT /containers/{name:.*}/archive` 返回 `500` 状态码而不是 `400` 的问题。[moby/moby#49219](https://github.com/moby/moby/pull/49219)
- `POST /containers/create` 现在在 `HostConfig.SecurityOpt` 中接受 `writable-cgroups=true` 选项，以挂载容器的可写 cgroups。这提供了比 `HostConfig.Privileged` 更精细的方法。[moby/moby#48828](https://github.com/moby/moby/pull/48828)
- `POST /build/prune` 将 `keep-bytes` 重命名为 `reserved-space`，现在支持额外的清理参数 `max-used-space` 和 `min-free-space`。[moby/moby#48720](https://github.com/moby/moby/pull/48720)
- `POST /networks/create` 现在有一个 `EnableIPv4` 字段。将其设置为 `false` 会禁用网络的 IPv4 IPAM。[moby/moby#48271](https://github.com/moby/moby/pull/48271)
  - `GET /networks/{id}` 现在返回一个 `EnableIPv4` 字段，显示网络是否启用了 IPv4 IPAM。[moby/moby#48271](https://github.com/moby/moby/pull/48271)
  - 用户定义的桥接网络需要启用 IPv4 或 IPv6 地址分配之一。默认桥接网络 (`docker0`) 不能禁用 IPv4。[moby/moby#48323](https://github.com/moby/moby/pull/48323)
  - `macvlan` 和 `ipvlan` 网络可以在创建时针对 IPv4、IPv6 或两者禁用地址分配。[moby/moby#48299](https://github.com/moby/moby/pull/48299)
  - Windows 网络或 Swarm 网络不能禁用 IPv4。[moby/moby#48278](https://github.com/moby/moby/pull/48278)
- 增加了指定哪个网络应为容器提供默认网关的方法。[moby/moby#48936](https://github.com/moby/moby/pull/48936)
  - `POST /networks/{id}/connect` 和 `POST /containers/create` 现在在 `EndpointsConfig` 中接受 `GwPriority` 字段。此值用于确定哪个网络端点为容器提供默认网关。选择具有最高优先级的端点。如果多个端点具有相同的优先级，则端点按其网络名称进行字典序排序，并选取排在前面的那一个。[moby/moby#48746](https://github.com/moby/moby/pull/48746)
  - `GET /containers/json` 现在在每个网络端点的 `NetworkSettings` 中返回一个 `GwPriority` 字段。该字段由 CLI 用于 `docker run` 和 `docker network connect` 的新 `gw-priority` 选项。[moby/moby#48746](https://github.com/moby/moby/pull/48746)
- `--sysctl` 选项中对 `eth0` 的设置不再自动迁移到网络端点。[moby/moby#48746](https://github.com/moby/moby/pull/48746)
    - 例如，在 Docker CLI 中，`docker run --network mynet --sysctl net.ipv4.conf.eth0.log_martians=1 ...` 将被拒绝。相反，您必须使用 `docker run --network name=mynet,driver-opt=com.docker.network.endpoint.sysctls=net.ipv4.conf.IFNAME.log_martians=1 ...`
- `GET /containers/json` 现在返回一个 `ImageManifestDescriptor` 字段，该字段与 `/containers/{name}/json` 中的相同字段匹配。仅当守护进程提供多平台镜像存储时，才会填充此字段。[moby/moby#49407](https://github.com/moby/moby/pull/49407)


### 已移除

- Fluent 日志选项 `fluentd-async-connect` 在 v20.10 中已弃用，现已移除。[moby/moby#46114](https://github.com/moby/moby/pull/46114)
- `docker stop` 和 `docker restart` 上的 `--time` 选项已弃用并重命名为 `--timeout`。[docker/cli#5485](https://github.com/docker/cli/pull/5485)
- Go-SDK：`pkg/ioutils`：移除了 `NewReaderErrWrapper`，因为它从未被使用过。[moby/moby#49258](https://github.com/moby/moby/pull/49258)
- Go-SDK：`pkg/ioutils`：移除了已弃用的 `BytesPipe`、`NewBytesPipe`、`ErrClosed`、`WriteCounter`、`NewWriteCounter`、`NewReaderErrWrapper`、`NopFlusher`。[moby/moby#49245](https://github.com/moby/moby/pull/49245)
- Go-SDK：`pkg/ioutils`：移除了已弃用的 `NopWriter` 和 `NopWriteCloser`。[moby/moby#49256](https://github.com/moby/moby/pull/49256)
- Go-SDK：`pkg/sysinfo`：移除了已弃用的 `NumCPU`。[moby/moby#49242](https://github.com/moby/moby/pull/49242)
- Go-SDK：移除了 `pkg/broadcaster`，因为它仅在内部使用 [moby/moby#49172](https://github.com/moby/moby/pull/49172)
- Go-SDK：移除了已弃用的 `cli.Errors` 类型 [docker/cli#5549](https://github.com/docker/cli/pull/5549)
- 移除了 `pkg/ioutils.ReadCloserWrapper`，因为它仅在测试中使用。[moby/moby#49237](https://github.com/moby/moby/pull/49237)
- 移除了已弃用的 `api-cors-header` 配置参数和 `dockerd` 的 `--api-cors-header` 选项 [moby/moby#48209](https://github.com/moby/moby/pull/48209)
- 移除了已弃用的 `APIEndpoint.Version` 字段、`APIVersion` 类型以及 `APIVersion1` 和 `APIVersion2` 常量。[moby/moby#49004](https://github.com/moby/moby/pull/49004)
- 移除了已弃用的 `api-cors-header` 配置参数和 Docker 守护进程的 `--api-cors-header` 选项。[docker/cli#5437](https://github.com/docker/cli/pull/5437)
- 移除了已弃用的 `pkg/directory` 包 [moby/moby#48779](https://github.com/moby/moby/pull/48779)
- 移除了已弃用的 `pkg/dmsg.Dmesg()` [moby/moby#48109](https://github.com/moby/moby/pull/48109)
- 移除了已弃用的 `image/spec` 包，它已被移动到独立模块 (`github.com/moby/docker-image-spec`) [moby/moby#48460](https://github.com/moby/moby/pull/48460)
- 移除了已弃用 `logentries` 日志驱动程序的迁移代码和错误信息。[moby/moby#48891](https://github.com/moby/moby/pull/48891)
- 移除了对已弃用的外部 graph-driver 插件的支持。[moby/moby#48072](https://github.com/moby/moby/pull/48072)
- `api/types`：移除了已弃用的 `container.ContainerNode` 和 `ContainerJSONBase.Node` 字段。[moby/moby#48107](https://github.com/moby/moby/pull/48107)
- `api/types`：移除了已弃用的别名：`ImagesPruneReport`、`VolumesPruneReport`、`NetworkCreateRequest`、`NetworkCreate`、`NetworkListOptions`、`NetworkCreateResponse`、`NetworkInspectOptions`、`NetworkConnect`、`NetworkDisconnect`、`EndpointResource`、`NetworkResource`、`NetworksPruneReport`、`ExecConfig`、`ExecStartCheck`、`ContainerExecInspect`、`ContainersPruneReport`、`ContainerPathStat`、`CopyToContainerOptions`、`ContainerStats`、`ImageSearchOptions`、`ImageImportSource`、`ImageLoadResponse`、`ContainerNode`。[moby/moby#48107](https://github.com/moby/moby/pull/48107)
- `libnetwork/iptables`：移除了已弃用的 `IPV`、`Iptables`、`IP6Tables` 和 `Passthrough()`。[moby/moby#49121](https://github.com/moby/moby/pull/49121)
- `pkg/archive`：移除了已弃用的 `CanonicalTarNameForPath`、`NewTempArchive`、`TempArchive` [moby/moby#48708](https://github.com/moby/moby/pull/48708)
- `pkg/fileutils`：移除了已弃用的 `GetTotalUsedFds` [moby/moby#49210](https://github.com/moby/moby/pull/49210)
- `pkg/ioutils`：移除了仅在内部使用的 `OnEOFReader` [moby/moby#49170](https://github.com/moby/moby/pull/49170)
- `pkg/longpath`：移除了已弃用的 `Prefix` 常量。[moby/moby#48779](https://github.com/moby/moby/pull/48779)
- `pkg/stringid`：移除了已弃用的 `IsShortID` 和 `ValidateID` 函数 [moby/moby#48705](https://github.com/moby/moby/pull/48705)
- `runconfig/opts`：移除了已弃用的 `ConvertKVStringsToMap` [moby/moby#48102](https://github.com/moby/moby/pull/48102)
- `runconfig`：移除了已弃用的 `ContainerConfigWrapper`、`SetDefaultNetModeIfBlank`、`DefaultDaemonNetworkMode`、`IsPreDefinedNetwork` [moby/moby#48102](https://github.com/moby/moby/pull/48102)
- `container`：移除了已弃用的 `ErrNameReserved`、`ErrNameNotReserved`。[moby/moby#48728](https://github.com/moby/moby/pull/48728)
- 移除了 `Daemon.ContainerInspectCurrent()` 方法，并将 `Daemon.ContainerInspect()` 签名更改为接受 `backend.ContainerInspectOptions` 结构体 [moby/moby#48672](https://github.com/moby/moby/pull/48672)
- 移除了已弃用的 `Daemon.Exists()` 和 `Daemon.IsPaused()` 方法。[moby/moby#48723](https://github.com/moby/moby/pull/48723)

### 弃用

- API：`GET /info` 响应中的 `BridgeNfIptables` 和 `BridgeNfIp6tables` 字段现在始终为 `false`，并将在 API v1.49 中被省略。netfilter 模块现在是按需加载的，不再在守护进程启动期间加载，使这些字段变得过时。[moby/moby#49114](https://github.com/moby/moby/pull/49114)
- API：对于返回 JSON 进度响应的端点 (如 `POST /images/create`、`POST /images/{name}/push` 和 `POST /build`)，流式响应中的 `error` 和 `progress` 字段现已弃用。[moby/moby#49447](https://github.com/moby/moby/pull/49447)
  - 用户应改用 `errorDetail` 和 `progressDetail` 字段中的信息。
  - 这些字段分别在 API v1.4 (docker v0.6.0) 和 API v1.8 (docker v0.7.1) 中被标记为弃用，但仍被返回。
  - 这些字段在未来的 API 版本中将保持为空或被省略。
- 弃用 `Daemon.Register()`。此函数未使用，将在下一个版本中移除。[moby/moby#48702](https://github.com/moby/moby/pull/48702)
- 弃用 `client.ImageInspectWithRaw` 函数，建议使用新的 `client.ImageInspect`。[moby/moby#48264](https://github.com/moby/moby/pull/48264)
- 弃用 `daemon/config.Config.ValidatePlatformConfig()`。此方法曾作为 `config.Validate` 的辅助方法，应改用后者。[moby/moby#48985](https://github.com/moby/moby/pull/48985)
- 弃用 `pkg/reexec`。此包已弃用并移至独立模块。请改用 `github.com/moby/sys/reexec`。[moby/moby#49129](https://github.com/moby/moby/pull/49129)
- 弃用用于推送不可分发制品 (non-distributable artifacts) 的配置 [docker/cli#5724](https://github.com/docker/cli/pull/5724)
- 弃用 `--allow-nondistributable-artifacts` 守护进程标志及 `daemon.json` 中对应的 `allow-nondistributable-artifacts` 字段。设置这两个选项将不再起作用，但会添加一条弃用警告日志。[moby/moby#49065](https://github.com/moby/moby/pull/49065)
- 弃用 `GET /info` API 响应中的 `RegistryConfig.AllowNondistributableArtifactsCIDRs` 和 `RegistryConfig.AllowNondistributableArtifactsHostnames` 字段。对于 API 版本 v1.48 及更早版本，响应中仍包含这些字段，但始终为 `null`。在 API 版本 v1.49 及更高版本中，该字段将完全省略。[moby/moby#49065](https://github.com/moby/moby/pull/49065)
- Go-SDK：弃用 `registry.ServiceOptions.AllowNondistributableArtifacts` 字段。[moby/moby#49065](https://github.com/moby/moby/pull/49065)
- Go-SDK：`api/types/system.Info` 中的 `BridgeNfIptables`、`BridgeNfIp6tables` 字段以及 `pkg/sysinfo.SysInfo` 中的 `BridgeNFCallIPTablesDisabled`、`BridgeNFCallIP6TablesDisabled` 字段已弃用，并将从下一个版本中移除。[moby/moby#49114](https://github.com/moby/moby/pull/49114)
- Go-SDK：`client`：弃用 `CommonAPIClient` 接口，建议使用 `APIClient` 接口。`CommonAPIClient` 将在下一个版本中改为 `APIClient` 的别名，并在其后的版本中移除。[moby/moby#49388](https://github.com/moby/moby/pull/49388)
- Go-SDK：`client`：弃用 `ErrorConnectionFailed` 辅助方法。此函数仅在内部使用，将在下一个版本中移除。[moby/moby#49389](https://github.com/moby/moby/pull/49389)
- Go-SDK：`pkg/ioutils`：弃用 `NewAtomicFileWriter`、`AtomicWriteFile`、`AtomicWriteSet`、`NewAtomicWriteSet`，建议使用 `pkg/atomicwriter` 中的等效项。[moby/moby#49171](https://github.com/moby/moby/pull/49171)
- Go-SDK：`pkg/sysinfo`：弃用 `NumCPU`。此工具的行为与 `runtime.NumCPU` 相同。[moby/moby#49241](https://github.com/moby/moby/pull/49241)
- Go-SDK：`pkg/system`：弃用 `MkdirAll`。此函数为 Windows GUID 卷路径提供了自定义处理。此类路径的处理现在自 go1.22 起由 Go 标准库支持，此函数现在是 `os.MkdirAll` 的别名，应改用后者。此别名将在下一个版本中移除。[moby/moby#49162](https://github.com/moby/moby/pull/49162)
- Go-SDK：弃用 `pkg/parsers.ParseKeyValueOpt`。[moby/moby#49177](https://github.com/moby/moby/pull/49177)
- Go-SDK：弃用 `pkg/parsers.ParseUintListMaximum`、`pkg/parsers.ParseUintList`。这些工具仅在内部使用，并在下一个版本中移除。[moby/moby#49222](https://github.com/moby/moby/pull/49222)
- Go-SDK：弃用 `api/type.IDResponse`，建议使用 `container.CommitResponse` 和 `container.ExecCreateResponse`，它们目前是别名，但在未来版本中可能成为独立类型。此类型将在下一个版本中移除。[moby/moby#49446](https://github.com/moby/moby/pull/49446)
- Go-SDK：弃用 `api/types/container.ContainerUpdateOKBody`，建议使用 `UpdateResponse`。此类型将在下一个版本中移除。[moby/moby#49442](https://github.com/moby/moby/pull/49442)
- Go-SDK：弃用 `api/types/container.ContainerTopOKBody`，建议使用 `TopResponse`。此类型将在下一个版本中移除。[moby/moby#49442](https://github.com/moby/moby/pull/49442)
- Go-SDK：`pkg/jsonmessage`：修正了 `ProgressMessage`、`ErrorMessage` 的弃用状态，它们分别在 Docker v0.6.0 和 v0.7.1 中被弃用。[moby/moby#49447](https://github.com/moby/moby/pull/49447)
- 将 `GraphDriverData` 从 `api/types` 移至 `api/types/storage`。旧类型已弃用，并将从下一个版本中移除。[moby/moby#48108](https://github.com/moby/moby/pull/48108)
- 将 `RequestPrivilegeFunc` 从 `api/types` 移至 `api/types/registry`。旧类型已弃用，并将从下一个版本中移除。[moby/moby#48119](https://github.com/moby/moby/pull/48119)
- 将以下内容从 `api/types` 移至 `api/types/container` - `NetworkSettings`、`NetworkSettingsBase`、`DefaultNetworkSettings`、`SummaryNetworkSettings`、`Health`、`HealthcheckResult`、`NoHealthcheck`、`Starting`、`Healthy` 和 `Unhealthy` 常量、`MountPoint`、`Port`、`ContainerState`、`Container`、`ContainerJSONBase`、`ContainerJSON`、`ContainerNode`。旧类型已弃用，并将从下一个版本中移除。[moby/moby#48108](https://github.com/moby/moby/pull/48108)
- 将以下内容从 `api/types` 移至 `api/types/image` - `ImageInspect`、`RootFS`。旧类型已弃用，并将从下一个版本中移除。[moby/moby#48108](https://github.com/moby/moby/pull/48108)
- `GET /info` 端点中的 `ContainerdCommit.Expected`、`RuncCommit.Expected` 和 `InitCommit.Expected` 字段现已弃用，并将在 API v1.49 中被省略。[moby/moby#48478](https://github.com/moby/moby/pull/48478)
- `api/types/registry`：弃用 `ServiceConfig.AllowNondistributableArtifactsCIDRs` 和 `ServiceConfig.AllowNondistributableArtifactsHostnames` 字段。这些字段将在下一个版本中移除。[moby/moby#49065](https://github.com/moby/moby/pull/49065)
- `api/types/system/Commit.Expected` 字段现已弃用，不应再使用。[moby/moby#48478](https://github.com/moby/moby/pull/48478)
- `daemon/graphdriver`：弃用 `GetDriver()` [moby/moby#48079](https://github.com/moby/moby/pull/48079)
- `libnetwork/iptables`：弃用 `Passthrough`。此函数仅在内部使用，将在下一个版本中移除。[moby/moby#49115](https://github.com/moby/moby/pull/49115)
- 弃用 `pkg/directory.Size()` 函数，并将从下一个版本中移除。[moby/moby#48057](https://github.com/moby/moby/pull/48057)
- `registry`：弃用 `APIEndpoint.TrimHostName`；现在对于远程名称无条件修剪主机名。此字段将在下一个版本中移除。[moby/moby#49005](https://github.com/moby/moby/pull/49005)
- `daemon.json` 中的 `allow-nondistributable-artifacts` 字段。设置这两个选项将不再生效，但会添加一条弃用警告日志以提高意识。此警告计划在下一个版本中变为错误。[moby/moby#49065](https://github.com/moby/moby/pull/49065)
